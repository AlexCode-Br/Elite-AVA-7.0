<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite AVA 7.0 | Painel de Estudos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByiaa41NkMJsIfqUxKr2zlb1UxJG_khoY", 
            authDomain: "sec-ba-8bd83.firebaseapp.com",
            projectId: "sec-ba-8bd83",
            storageBucket: "sec-ba-8bd83.firebasestorage.app",
            messagingSenderId: "1083493409182",
            appId: "1:1083493409182:web:6e5052aa56d23c3192b68f"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.signInAnonymously = signInAnonymously;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.updateProfile = updateProfile;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.setPersistence = setPersistence;
        window.browserLocalPersistence = browserLocalPersistence;
        window.browserSessionPersistence = browserSessionPersistence;
        window.signOut = signOut;
        
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');

        onAuthStateChanged(window.auth, (user) => {
            if (user) {
                if (typeof window.handleLoginData === 'function') {
                    window.handleLoginData(user);
                }
            } else {
                const overlay = document.getElementById('login-overlay');
                if(overlay) {
                    overlay.classList.remove('opacity-0', 'pointer-events-none');
                    overlay.classList.remove('hidden');
                }
            }
        });
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif']
                    },
                    colors: {
                        dark: {
                            900: '#050911',
                            800: '#0e1421', 
                            700: '#172033', 
                        },
                        neon: {
                            blue: '#00f3ff',
                            purple: '#bc13fe',
                            green: '#0aff60',
                            gold: '#ffd700',
                            red: '#ff2a6d'
                        }
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'level-up': 'levelUp 0.8s ease-out forwards',
                        'scan': 'scan 2s linear infinite',
                        'bounce-slow': 'bounce 3s infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        pulseGlow: {
                            '0%, 100%': { opacity: '1', boxShadow: '0 0 20px rgba(188, 19, 254, 0.5)' },
                            '50%': { opacity: '.8', boxShadow: '0 0 10px rgba(188, 19, 254, 0.2)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        levelUp: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '60%': { transform: 'scale(1.2)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        scan: {
                            '0%': { backgroundPosition: '0% 0%' },
                            '100%': { backgroundPosition: '100% 100%' }
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-font-smoothing: antialiased; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-right: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-panel { background: rgba(14, 20, 33, 0.95); border-right: 1px solid rgba(255, 255, 255, 0.05); }

        .nav-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 12px; margin-bottom: 6px; }
        .nav-item.active { background: linear-gradient(90deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0) 100%); border-left: 4px solid #2563eb; }
        .dark .nav-item.active { background: linear-gradient(90deg, rgba(188,19,254,0.2) 0%, rgba(188,19,254,0) 100%); border-left: 4px solid #bc13fe; }

        .custom-checkbox input:checked + div { background-color: #10b981; border-color: #10b981; transform: scale(1.1) rotate(3deg); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        
        .hover-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-card:hover { transform: translateY(-3px); }
        .dark .hover-card:hover { box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); border-color: rgba(188, 19, 254, 0.3); }

        .auth-checkbox { appearance: none; background-color: transparent; margin: 0; font: inherit; color: currentColor; width: 1.15em; height: 1.15em; border: 2px solid #64748b; border-radius: 0.25em; display: grid; place-content: center; transition: all 0.2s; }
        .auth-checkbox::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .auth-checkbox:checked { background-color: #bc13fe; border-color: #bc13fe; box-shadow: 0 0 10px rgba(188, 19, 254, 0.4); }
        .auth-checkbox:checked::before { transform: scale(1); }
        .auth-checkbox:focus { outline: none; border-color: #bc13fe; }

        .input-error { border-color: #ef4444 !important; animation: shake 0.5s; }
        .input-error:focus { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #ef4444 !important; }
        .form-slide-enter { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.4s ease-out; }
        .form-slide-enter.active { max-height: 200px; opacity: 1; }
        .strength-segment { transition: all 0.3s ease; height: 4px; border-radius: 2px; background-color: #374151; }
        .strength-segment.active { background-color: #ef4444; box-shadow: 0 0 5px currentColor; }

        #main-sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-open { transform: translateX(0) !important; }

        .profile-tab { transition: all 0.2s; border-bottom: 2px solid transparent; color: #64748b; }
        .dark .profile-tab { color: #94a3b8; }
        .profile-tab.active { border-color: #2563eb; color: #2563eb; font-weight: 600; }
        .dark .profile-tab.active { border-color: #bc13fe; color: #bc13fe; }
        
        .theme-btn.active { background-color: rgba(59, 130, 246, 0.1); color: #2563eb; font-weight: 600; }
        .dark .theme-btn.active { background-color: rgba(188, 19, 254, 0.2); color: #bc13fe; }
    </style>
</head>

<body class="bg-slate-50 dark:bg-dark-900 text-slate-800 dark:text-slate-100 h-[100dvh] flex overflow-hidden transition-colors duration-300">

    <div id="login-overlay" class="fixed inset-0 z-[100] bg-dark-900 flex items-center justify-center p-4 transition-opacity duration-500 overflow-y-auto">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-20 -left-20 w-96 h-96 bg-blue-600/10 rounded-full blur-3xl animate-pulse"></div>
            <div class="absolute -bottom-20 -right-20 w-96 h-96 bg-neon-purple/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
            <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5"></div>
        </div>

        <div class="bg-dark-800/80 backdrop-blur-xl rounded-3xl shadow-2xl w-full max-w-[400px] p-8 text-center animate-slide-up relative border border-white/5 overflow-hidden ring-1 ring-white/10">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-neon-purple to-neon-red"></div>
            <div class="mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-purple-500/20 ring-4 ring-white/5">
                    <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-display font-bold text-white tracking-tight">Elite AVA <span class="text-neon-purple">7.0</span></h1>
                <p class="text-slate-400 text-sm mt-2" id="auth-subtitle">Entre para continuar sua evolu√ß√£o</p>
            </div>

            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-5 text-left" novalidate>
                <div id="field-name-container" class="form-slide-enter">
                    <label class="text-xs text-slate-400 font-bold ml-1 mb-1 block uppercase tracking-wide">Nome Completo</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-500 group-focus-within:text-neon-purple transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <input type="text" id="auth-name" placeholder="Seu nome de guerreiro" 
                            class="w-full bg-dark-900/50 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-neon-purple focus:ring-1 focus:ring-neon-purple transition-all"
                            oninput="clearError(this)">
                    </div>
                </div>

                <div>
                    <label class="text-xs text-slate-400 font-bold ml-1 mb-1 block uppercase tracking-wide">E-mail</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-500 group-focus-within:text-neon-blue transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <input type="email" id="auth-email" placeholder="seu@email.com" 
                            class="w-full bg-dark-900/50 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-neon-blue focus:ring-1 focus:ring-neon-blue transition-all"
                            oninput="clearError(this); validateEmailLive(this);">
                    </div>
                    <p class="text-red-500 text-[10px] mt-1 hidden font-medium flex items-center gap-1" id="error-email">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>E-mail inv√°lido</span>
                    </p>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs text-slate-400 font-bold ml-1 uppercase tracking-wide">Senha</label>
                        <button type="button" onclick="handleForgotPassword()" class="text-[10px] text-neon-blue hover:text-white transition font-medium" id="forgot-link">Esqueci a senha</button>
                    </div>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-500 group-focus-within:text-neon-purple transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                            class="w-full bg-dark-900/50 border border-slate-700 rounded-xl py-3 pl-10 pr-10 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-neon-purple focus:ring-1 focus:ring-neon-purple transition-all"
                            oninput="clearError(this); checkPasswordStrength(this.value)">
                        
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <button type="button" onclick="togglePasswordVisibility()" class="text-slate-500 hover:text-white focus:outline-none p-2">
                                <svg id="eye-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="eye-off-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 011.574-2.59M6 6l12 12" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.88 9.88a3 3 0 104.24 4.24" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-red-500 text-[10px] mt-1 hidden font-medium flex items-center gap-1" id="error-password">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Senha inv√°lida</span>
                    </p>

                    <div id="password-strength-container" class="form-slide-enter mt-2">
                        <div class="flex gap-1 h-1 w-full">
                            <div id="strength-1" class="flex-1 rounded-full bg-slate-700 transition-colors duration-300"></div>
                            <div id="strength-2" class="flex-1 rounded-full bg-slate-700 transition-colors duration-300"></div>
                            <div id="strength-3" class="flex-1 rounded-full bg-slate-700 transition-colors duration-300"></div>
                            <div id="strength-4" class="flex-1 rounded-full bg-slate-700 transition-colors duration-300"></div>
                        </div>
                        <p id="strength-text" class="text-[10px] text-right text-slate-500 mt-1">For√ßa da senha</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="remember-me" class="auth-checkbox">
                    <label for="remember-me" class="text-sm text-slate-300 cursor-pointer select-none">Lembrar de mim</label>
                </div>

                <button type="submit" id="auth-btn" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold shadow-lg shadow-purple-900/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2 border border-white/10 group min-h-[50px]">
                    <span>Entrar na Plataforma</span>
                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
            </form>

            <div class="mt-6 pt-6 border-t border-white/5">
                <p class="text-sm text-slate-400" id="auth-toggle-text">
                    N√£o tem uma conta? 
                    <button onclick="toggleAuthMode()" class="text-neon-purple font-bold hover:text-white transition-colors ml-1 focus:outline-none p-2">Cadastre-se</button>
                </p>
                <div id="guest-option" class="mt-4">
                     <button onclick="handleGuestLogin()" class="text-xs font-semibold text-slate-500 hover:text-slate-300 transition flex items-center justify-center gap-1 mx-auto w-full py-3 rounded-lg hover:bg-white/5 min-h-[44px]">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        Acessar como Visitante
                    </button>
                </div>
            </div>

            <div id="auth-global-error" class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-xs font-medium hidden text-left flex items-start gap-2 animate-shake">
                <svg class="w-4 h-4 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <span id="global-error-text"></span>
            </div>
        </div>
    </div>

    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden transition-opacity md:hidden" onclick="toggleSidebar()"></div>
    
    <aside id="main-sidebar" class="glass-panel w-72 md:w-64 flex flex-col z-50 h-full fixed top-0 left-0 bg-white dark:bg-dark-800 border-r border-slate-200 dark:border-white/5 shadow-2xl md:shadow-none -translate-x-full md:translate-x-0 group">
        <button onclick="toggleSidebar()" class="absolute top-4 right-4 md:hidden text-slate-500 hover:text-white p-2">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <button onclick="toggleSidebarDesktop()" class="absolute -right-3 top-20 bg-white dark:bg-dark-800 border border-slate-200 dark:border-white/10 rounded-full p-1.5 shadow-md z-50 hidden md:flex items-center justify-center text-slate-500 hover:text-blue-500 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
        </button>

        <div class="p-6 flex items-center gap-3 font-display font-bold text-xl text-slate-900 dark:text-white border-b border-slate-100 dark:border-white/5 h-[80px] overflow-hidden whitespace-nowrap">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-neon-purple rounded-lg flex items-center justify-center text-white shadow-[0_0_15px_rgba(37,99,235,0.5)] shrink-0">
                <span class="text-xs font-bold">7.0</span>
            </div>
            <span id="logo-text" class="transition-opacity duration-300">Elite AVA</span>
        </div>
        <nav class="flex-1 px-4 space-y-3 mt-6 overflow-y-auto overflow-x-hidden">
            <div onclick="switchView('dashboard')" class="nav-item active flex items-center px-4 py-4 text-base font-semibold cursor-pointer text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white whitespace-nowrap group">
                <svg class="w-6 h-6 mr-3 shrink-0 text-blue-500 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                <span class="nav-label">Painel de Estudos</span>
            </div>
            <div onclick="switchView('library')" class="nav-item flex items-center px-4 py-4 text-base font-semibold cursor-pointer text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white whitespace-nowrap group">
                <svg class="w-6 h-6 mr-3 shrink-0 text-purple-500 group-hover:text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <span class="nav-label">Biblioteca</span>
            </div>
            <div onclick="switchView('schedule')" class="nav-item flex items-center px-4 py-4 text-base font-semibold cursor-pointer text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white whitespace-nowrap group">
                <svg class="w-6 h-6 mr-3 shrink-0 text-green-500 group-hover:text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span class="nav-label">Cronograma</span>
            </div>
            <div onclick="switchView('achievements')" class="nav-item flex items-center px-4 py-4 text-base font-semibold cursor-pointer text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white whitespace-nowrap group">
                <svg class="w-6 h-6 mr-3 shrink-0 text-yellow-500 group-hover:text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>
                <span class="nav-label">Conquistas</span>
            </div>
            <div onclick="switchView('edital')" class="nav-item flex items-center px-4 py-4 text-base font-semibold cursor-pointer text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white whitespace-nowrap group">
                <svg class="w-6 h-6 mr-3 shrink-0 text-pink-500 group-hover:text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"></path><path d="M12 8v4"></path><path d="M5 12h14"></path><path d="M5 12v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6"></path><circle cx="9" cy="16" r="1"></circle><circle cx="15" cy="16" r="1"></circle></svg>
                <span class="nav-label">IA T√°tica</span>
            </div>
            <div onclick="switchView('stats')" class="nav-item flex items-center px-4 py-4 text-base font-semibold cursor-pointer text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white whitespace-nowrap group">
                <svg class="w-6 h-6 mr-3 shrink-0 text-cyan-500 group-hover:text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                <span class="nav-label">Analytics</span>
            </div>
        </nav>
        
        <div class="p-4 border-t border-slate-200 dark:border-white/5">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-2 nav-label">Apar√™ncia</p>
            <div class="flex bg-slate-100 dark:bg-black/20 p-1 rounded-xl nav-label">
                <button onclick="setTheme('light')" id="theme-btn-light" class="theme-btn flex-1 p-2 rounded-lg text-slate-500 hover:text-blue-500 transition relative group" title="Claro">
                    <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </button>
                <button onclick="setTheme('dark')" id="theme-btn-dark" class="theme-btn flex-1 p-2 rounded-lg text-slate-500 hover:text-purple-500 transition relative group" title="Escuro">
                    <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                <button onclick="setTheme('system')" id="theme-btn-system" class="theme-btn flex-1 p-2 rounded-lg text-slate-500 hover:text-green-500 transition relative group" title="Sistema">
                    <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-[100dvh] overflow-hidden relative ml-0 md:ml-64 transition-all duration-300">
        
        <header class="h-16 md:h-20 px-4 md:px-8 bg-white/80 dark:bg-dark-900/90 backdrop-blur-md z-30 shrink-0 border-b border-slate-200 dark:border-white/5 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-600 dark:text-white p-2 -ml-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                </button>
                <div class="flex flex-col justify-center">
                    <h1 class="text-lg md:text-2xl font-display font-bold text-slate-900 dark:text-white tracking-tight">
                        Ol√°, <span id="header-name" class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 dark:from-neon-blue dark:to-neon-purple cursor-pointer hover:underline" onclick="openProfileModal()">Estudante</span>
                    </h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">Meta: Aprova√ß√£o SEC/BA ‚Ä¢ Faltam <span id="header-countdown" class="font-bold text-red-500">--</span> dias</p>
                </div>
            </div>

            <div class="flex items-center gap-3 md:gap-6">
                <div class="hidden sm:block w-32 md:w-48">
                    <div class="flex justify-between text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1">
                        <span>XP ATUAL</span>
                        <span id="xp-text">0 / 300</span>
                    </div>
                    <div class="h-2.5 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden relative shadow-inner">
                        <div id="xp-bar" class="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 progress-bar-striped rounded-full transition-all duration-1000 w-[0%] relative">
                            <div class="absolute right-0 top-0 bottom-0 w-2 bg-white/50 blur-[2px]"></div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold text-slate-400 uppercase hidden sm:inline">Sequ√™ncia</span>
                        <div class="flex items-center gap-1 text-orange-500 font-bold text-base md:text-lg animate-pulse">
                            <span id="streak-fire">üî•</span> <span id="streak-count">0</span>
                        </div>
                    </div>
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-white dark:bg-dark-800 rounded-full border-2 border-blue-600 dark:border-neon-purple flex items-center justify-center text-slate-900 dark:text-white font-display font-bold text-lg md:text-xl shadow-[0_0_15px_rgba(59,130,246,0.2)] dark:shadow-[0_0_15px_rgba(188,19,254,0.4)] relative cursor-pointer hover:scale-110 transition" onclick="openProfileModal()">
                        <span id="level-circle">1</span>
                        <span class="absolute -bottom-1 -right-1 bg-blue-600 text-[8px] px-1 rounded text-white font-bold border border-white dark:border-dark-900">NVL</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar bg-slate-50 dark:bg-dark-900 transition-colors" id="main-scroll">
            
            <div id="view-dashboard" class="w-full space-y-6 md:space-y-8 fade-in text-left pb-20">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="col-span-1 bg-white dark:bg-dark-800 rounded-3xl p-6 border border-slate-100 dark:border-white/5 shadow-lg relative overflow-hidden group hover-card">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg class="w-24 h-24 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/></svg>
                        </div>
                        <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-4">Progresso Geral</h3>
                        <div class="flex items-center gap-6">
                            <div class="relative w-24 h-24 flex items-center justify-center">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-200 dark:text-white/5" />
                                    <circle id="dash-circle-progress" cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="text-blue-500 dark:text-neon-blue transition-all duration-1000 ease-out" stroke-linecap="round" />
                                </svg>
                                <span class="absolute text-xl font-bold text-slate-800 dark:text-white" id="dash-percent-text">0%</span>
                            </div>
                            <div>
                                <div class="text-3xl font-display font-bold text-slate-900 dark:text-white mb-1" id="dash-completed-count">0</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Tarefas Conclu√≠das</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-1 md:col-span-2 bg-gradient-to-br from-indigo-900 to-dark-900 rounded-3xl p-1 border border-white/10 shadow-lg relative overflow-hidden group hover-card">
                        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                        <div class="bg-dark-900/40 backdrop-blur-sm h-full rounded-[20px] p-6 relative z-10 flex flex-col justify-between">
                            <div class="flex flex-col sm:flex-row justify-between items-start mb-4">
                                <div class="w-full">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="bg-neon-purple/20 text-neon-purple border border-neon-purple/30 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-widest shadow-[0_0_10px_rgba(188,19,254,0.3)] animate-pulse">Meta Di√°ria</span>
                                        <span class="text-xs text-white/70 font-bold" id="daily-progress-text">0/0 Completas</span>
                                    </div>
                                    <h3 class="text-2xl font-display font-bold text-white mb-2 leading-tight">Objetivos de Hoje</h3>
                                    <div class="w-full h-4 bg-black/50 rounded-full overflow-hidden border border-white/10 relative">
                                        <div id="daily-progress-bar" class="h-full bg-gradient-to-r from-neon-green to-emerald-600 w-0 transition-all duration-700"></div>
                                    </div>
                                    <p class="text-slate-300 text-xs mt-3">Complete tudo para manter o foco e ganhar b√¥nus.</p>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-3">
                                <button onclick="scrollToTasks()" class="px-6 py-3 bg-white text-black font-bold rounded-xl hover:bg-slate-200 transition shadow-lg active:scale-95 flex items-center gap-2 w-full sm:w-auto justify-center min-h-[44px]">
                                    Ver Tarefas
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-800 rounded-3xl p-4 md:p-6 border border-slate-100 dark:border-white/5 shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="font-display font-bold text-xl text-slate-800 dark:text-white flex items-center gap-2">
                            <span class="text-blue-500">üìÖ</span> Agenda
                        </h3>
                        <div class="flex bg-slate-100 dark:bg-dark-900 rounded-xl p-1 border border-slate-200 dark:border-white/5 w-full sm:w-auto justify-between sm:justify-start">
                            <button onclick="changeCalendarDate(-1)" class="p-2 hover:bg-white dark:hover:bg-white/10 rounded-lg transition text-slate-500 dark:text-slate-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span class="px-4 py-2 text-sm font-bold text-slate-700 dark:text-white min-w-[120px] text-center" id="calendar-header-label">M√™s Ano</span>
                            <button onclick="changeCalendarDate(1)" class="p-2 hover:bg-white dark:hover:bg-white/10 rounded-lg transition text-slate-500 dark:text-slate-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-7 gap-1 md:gap-2 mb-8">
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">Dom</div>
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">Seg</div>
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">Ter</div>
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">Qua</div>
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">Qui</div>
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">Sex</div>
                        <div class="text-center text-[10px] font-bold text-slate-400 uppercase py-2">S√°b</div>
                        <div id="calendar-grid" class="contents"></div>
                    </div>

                    <div id="task-section">
                        <div class="mb-8 border border-slate-200 dark:border-neon-purple/30 bg-white dark:bg-dark-900/80 rounded-2xl overflow-hidden shadow-lg dark:shadow-[0_0_20px_rgba(188,19,254,0.1)] relative group transition-colors">
                            <div class="bg-slate-50 dark:bg-gradient-to-r dark:from-neon-purple/20 dark:to-transparent p-4 border-b border-slate-100 dark:border-white/5 flex justify-between items-center relative overflow-hidden">
                                <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5 dark:opacity-10"></div>
                                <h4 class="font-display font-bold text-slate-800 dark:text-white flex items-center gap-2 relative z-10">
                                    <span class="text-xl">üìù</span> Resumo <span class="hidden sm:inline">do Conte√∫do</span> <span id="intel-date" class="text-slate-400 dark:opacity-70 ml-2 text-xs font-mono font-normal"></span>
                                </h4>
                            </div>
                            
                            <div id="daily-briefing-wrapper" class="p-6 relative">
                                <div id="daily-briefing-loading" class="hidden flex flex-col items-center justify-center py-8 space-y-4">
                                    <div class="w-12 h-12 border-4 border-purple-600 dark:border-neon-purple border-t-transparent rounded-full animate-spin"></div>
                                    <p class="text-purple-600 dark:text-neon-purple font-mono text-sm animate-pulse">PREPARANDO RESUMO...</p>
                                </div>
                                
                                <div id="daily-briefing-content" class="intel-content prose prose-slate dark:prose-invert prose-sm max-w-none text-slate-900 dark:text-slate-300">
                                    <div class="flex items-center justify-center py-8 text-slate-500 text-center">
                                        <p>Selecione uma data no calend√°rio para ver o resumo.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-300 dark:via-neon-purple to-transparent opacity-50"></div>
                        </div>

                        <h4 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4 flex justify-between items-center">
                            <span>Tarefas do Dia</span>
                            <span id="selected-date-label" class="text-slate-800 dark:text-white">Hoje</span>
                        </h4>
                        <div id="today-container" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <div id="view-library" class="hidden w-full fade-in pb-20">
                <div class="bg-white dark:bg-dark-800 p-6 md:p-8 rounded-3xl border border-slate-200 dark:border-white/5 mb-8">
                    <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-2">Biblioteca</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm md:text-base">Acesse todo o material do edital organizado por mat√©ria.</p>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="relative w-full md:w-64">
                            <select id="library-filter-select" onchange="setLibraryFilter(this.value)" class="w-full appearance-none bg-slate-50 dark:bg-dark-900 border-2 border-slate-200 dark:border-white/10 text-slate-700 dark:text-slate-300 py-3 px-4 pr-8 rounded-xl leading-tight focus:outline-none focus:border-blue-500 dark:focus:border-neon-blue transition-colors cursor-pointer font-bold text-sm min-h-[44px]">
                                </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>

                        <div class="relative flex-1">
                            <input type="text" id="search-input" placeholder="Pesquisar..." class="w-full bg-slate-50 dark:bg-dark-900 border-2 border-slate-200 dark:border-white/10 rounded-2xl py-3 md:py-4 pl-12 pr-4 text-slate-800 dark:text-white focus:border-neon-purple focus:ring-0 transition-colors" onkeyup="searchContent()">
                            <svg class="w-6 h-6 text-slate-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
                <div id="library-results" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    </div>
            </div>

            <div id="view-achievements" class="hidden w-full fade-in pb-20">
                <div class="bg-gradient-to-r from-yellow-600 to-yellow-800 p-6 md:p-8 rounded-3xl text-white mb-8 shadow-lg relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                    <h2 class="text-2xl md:text-3xl font-display font-bold relative z-10">Quadro de Medalhas</h2>
                    <p class="text-yellow-100 relative z-10 text-sm md:text-base">Acompanhe seus marcos de aprendizado.</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4" id="achievements-grid">
                    </div>
            </div>

            <div id="view-schedule" class="hidden w-full fade-in pb-20">
                <div class="mb-8">
                    <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white">Jornada</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm md:text-base">Seu caminho estrat√©gico rumo √† aprova√ß√£o.</p>
                </div>
                
                <div class="relative flex flex-col gap-8 pb-12">
                    <div class="absolute left-[1.4rem] top-0 bottom-0 w-1 bg-slate-200 dark:bg-white/5 rounded-full"></div>
                    <div id="full-schedule-container" class="space-y-8">
                        </div>
                </div>
            </div>

            <div id="view-edital" class="hidden w-full h-full flex flex-col md:flex-row gap-6 fade-in pb-4">
                <div class="w-full md:w-1/2 bg-white dark:bg-dark-800 rounded-3xl border border-slate-200 dark:border-white/5 overflow-hidden flex flex-col h-[40vh] md:h-auto min-h-[300px]">
                    <div class="p-4 border-b border-slate-100 dark:border-white/5 flex justify-between items-center bg-slate-50 dark:bg-dark-900">
                        <span class="font-bold text-slate-700 dark:text-white">Visualizador PDF</span>
                        <button onclick="toggleFullscreenPDF()" class="text-xs font-bold text-blue-500 hover:underline p-2">Expandir</button>
                    </div>
                    <div class="flex-1 bg-slate-200 relative">
                        <iframe id="pdf-frame" class="w-full h-full absolute inset-0" src="edital.pdf"></iframe>
                    </div>
                </div>
                <div class="w-full md:w-1/2 bg-white dark:bg-dark-800 rounded-3xl border border-slate-200 dark:border-white/5 overflow-hidden flex flex-col h-[40vh] md:h-auto min-h-[300px] shadow-xl">
                    <div class="p-4 border-b border-slate-100 dark:border-white/5 bg-slate-50 dark:bg-dark-900">
                        <span class="font-bold text-purple-600 dark:text-neon-purple flex items-center gap-2"><span class="animate-pulse">‚ú®</span> IA T√°tica</span>
                    </div>
                    <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50 dark:bg-dark-900/50">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-neon-purple to-blue-600 flex items-center justify-center text-white text-[10px] font-bold shrink-0">IA</div>
                            <div class="bg-white dark:bg-dark-700 p-3 rounded-2xl rounded-tl-none border border-slate-100 dark:border-white/5 text-sm text-slate-700 dark:text-slate-200 shadow-sm">
                                Ol√°! Sou sua assistente. Como posso ajudar com o edital?
                            </div>
                        </div>
                    </div>
                    <form onsubmit="handleChat(event)" class="p-4 bg-white dark:bg-dark-800 border-t border-slate-100 dark:border-white/5 relative">
                        <input id="chat-input" type="text" placeholder="Digite sua pergunta..." class="w-full bg-slate-100 dark:bg-dark-900 border border-transparent focus:border-neon-purple rounded-xl py-3 pl-4 pr-12 text-sm text-slate-800 dark:text-white outline-none transition-all">
                        <button type="submit" class="absolute right-6 top-1/2 transform -translate-y-1/2 text-neon-purple hover:text-white hover:bg-neon-purple rounded-lg p-1.5 transition">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="view-stats" class="hidden w-full fade-in pb-20 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-2">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white">Estat√≠sticas</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1 text-sm md:text-base">M√©tricas detalhadas do seu desempenho.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="col-span-1 lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-white dark:bg-dark-800 p-6 rounded-3xl border border-slate-100 dark:border-white/5 shadow-sm relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-16 h-16 text-neon-purple" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg></div>
                            <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2">XP Total</div>
                            <div class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 dark:from-neon-blue dark:to-neon-purple mt-1" id="stat-xp">0</div>
                        </div>

                        <div class="bg-white dark:bg-dark-800 p-6 rounded-3xl border border-slate-100 dark:border-white/5 shadow-sm relative overflow-hidden group">
                             <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-16 h-16 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg></div>
                            <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2">Tarefas</div>
                            <div class="text-4xl font-display font-bold text-slate-800 dark:text-white mt-1" id="stat-completed">0</div>
                        </div>

                        <div class="bg-white dark:bg-dark-800 p-6 rounded-3xl border border-slate-100 dark:border-white/5 shadow-sm relative overflow-hidden group">
                             <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-16 h-16 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg></div>
                            <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2">Horas Estudo</div>
                            <div class="text-4xl font-display font-bold text-slate-800 dark:text-white mt-1" id="stat-hours">0h</div>
                        </div>

                        <div class="bg-gradient-to-br from-slate-800 to-black text-white p-6 rounded-3xl border border-slate-700/50 shadow-sm relative overflow-hidden group">
                            <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                            <div class="text-xs text-white/60 uppercase font-bold tracking-wider mb-2">N√≠vel Atual</div>
                            <div class="text-2xl font-display font-bold text-white mt-1 flex items-center gap-2">
                                <span id="stat-rank-icon">üéì</span>
                                <span id="stat-rank-text">Iniciante</span>
                            </div>
                            <div class="text-xs text-white/40 mt-2">N√≠vel <span id="stat-level">1</span></div>
                        </div>
                    </div>

                    <div class="col-span-1 bg-white dark:bg-dark-800 p-6 rounded-3xl border border-slate-100 dark:border-white/5 shadow-sm flex flex-col">
                        <h3 class="font-bold text-slate-800 dark:text-white mb-4 text-sm uppercase tracking-wider">Radar</h3>
                        <div class="flex-1 relative min-h-[250px] lg:min-h-0">
                            <canvas id="subjectChart"></canvas>
                        </div>
                    </div>

                </div>

                <div class="bg-white dark:bg-dark-800 p-4 md:p-6 rounded-3xl border border-slate-100 dark:border-white/5">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 dark:text-white text-lg">Hist√≥rico</h3>
                        <div class="text-xs text-slate-400 font-mono">Registro Cronol√≥gico</div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[500px]">
                            <thead>
                                <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 dark:border-white/5">
                                    <th class="py-3 font-bold pl-2">Conte√∫do</th>
                                    <th class="py-3 font-bold">Mat√©ria</th>
                                    <th class="py-3 font-bold text-right pr-2">Conclus√£o</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="text-sm"></tbody>
                        </table>
                        <div id="history-empty-state" class="hidden py-8 text-center text-slate-400 text-sm">
                            Nenhum conte√∫do estudado ainda. Comece sua jornada!
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="content-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-800 w-[95%] md:w-full md:max-w-2xl rounded-3xl shadow-2xl border border-slate-200 dark:border-white/10 flex flex-col max-h-[90vh] overflow-hidden animate-slide-up">
            <div class="p-4 md:p-6 border-b border-slate-100 dark:border-white/5 flex justify-between items-start bg-slate-50 dark:bg-dark-900">
                <div>
                    <span id="modal-tag" class="text-[10px] font-bold uppercase tracking-wider bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 px-2 py-1 rounded">T√≥pico</span>
                    <h3 id="modal-title" class="text-lg md:text-xl font-bold text-slate-900 dark:text-white mt-2">T√≠tulo</h3>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto bg-white dark:bg-dark-800 text-slate-700 dark:text-slate-300">
                <div id="modal-body" class="mb-6 leading-relaxed text-sm md:text-base"></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <button onclick="openExternalSearch('youtube')" class="flex items-center justify-center gap-2 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl font-bold hover:bg-red-100 transition border border-red-200 dark:border-red-900/30 min-h-[44px]">
                        V√≠deo Aula
                    </button>
                    <button onclick="openExternalSearch('google')" class="flex items-center justify-center gap-2 p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl font-bold hover:bg-blue-100 transition border border-blue-200 dark:border-blue-900/30 min-h-[44px]">
                        Material Extra
                    </button>
                </div>
                <div id="quiz-box" class="hidden border-t border-slate-100 dark:border-white/5 pt-6">
                    <h4 class="font-bold text-purple-600 dark:text-neon-purple mb-3">Resumo Inteligente</h4>
                    <div id="quiz-content" class="prose prose-sm dark:prose-invert max-w-none"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 dark:border-white/5 bg-slate-50 dark:bg-dark-900 flex gap-3">
                <button onclick="generateQuiz()" id="btn-quiz" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-purple-600 dark:from-neon-purple dark:to-blue-600 text-white font-bold rounded-xl hover:shadow-lg transition min-h-[44px]">Gerar Resumo IA</button>
            </div>
        </div>
    </div>

    <div id="pdf-modal" class="fixed inset-0 z-[200] hidden bg-dark-900 flex flex-col animate-in fade-in zoom-in duration-200">
        <div class="flex items-center justify-between p-4 border-b border-white/10 bg-dark-800 shrink-0">
            <h3 class="font-bold text-white flex items-center gap-2">
                <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                Modo Leitura
            </h3>
            <button onclick="toggleFullscreenPDF()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition text-white">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="flex-1 bg-slate-200 relative overflow-hidden">
            <iframe id="pdf-frame-fullscreen" class="w-full h-full border-none" src="edital.pdf"></iframe>
        </div>
    </div>

    <div id="achievement-toast" class="fixed top-20 right-4 z-[150] translate-x-full transition-transform duration-500 flex items-center gap-4 bg-white dark:bg-dark-800 border border-yellow-400/50 dark:border-neon-gold/50 p-4 rounded-xl shadow-2xl max-w-[90vw]">
        <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-neon-gold/20 flex items-center justify-center text-xl text-yellow-600 dark:text-neon-gold shrink-0">üèÖ</div>
        <div>
            <h4 class="text-xs font-bold text-yellow-600 dark:text-neon-gold uppercase">Conquista Atualizada</h4>
            <p class="text-sm font-bold text-slate-900 dark:text-white line-clamp-2" id="toast-title">T√≠tulo</p>
        </div>
    </div>

    <div id="level-up-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="relative bg-white dark:bg-dark-800 p-8 rounded-3xl border border-slate-200 dark:border-neon-purple text-center animate-level-up shadow-2xl w-full max-w-sm mx-auto overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-purple-500/10 pointer-events-none"></div>
            <div class="absolute -top-12 left-1/2 transform -translate-x-1/2 w-24 h-24 bg-gradient-to-br from-neon-purple to-blue-600 rounded-full flex items-center justify-center border-4 border-white dark:border-dark-900 shadow-xl relative z-10">
                <span class="text-4xl">üéì</span>
            </div>
            <div class="relative z-10 mt-8">
                <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-2">NOVO N√çVEL!</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6">Voc√™ alcan√ßou o N√≠vel <span id="new-level-display" class="text-blue-600 dark:text-white font-bold text-xl">--</span></p>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-100 dark:bg-dark-900 p-3 rounded-xl border border-slate-200 dark:border-white/5">
                        <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">T√≠tulo</div>
                        <div class="text-blue-600 dark:text-neon-blue font-bold truncate text-sm" id="new-rank-display">--</div>
                    </div>
                    <div class="bg-slate-100 dark:bg-dark-900 p-3 rounded-xl border border-slate-200 dark:border-white/5">
                        <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">B√¥nus</div>
                        <div class="text-green-600 dark:text-neon-green font-bold text-sm">Dica de Estudo</div>
                    </div>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-200 dark:border-yellow-700/30 mb-6 text-left">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-yellow-600 dark:text-yellow-400">üí°</span>
                        <span class="text-xs font-bold text-yellow-700 dark:text-yellow-400 uppercase">Insight</span>
                    </div>
                    <p class="text-xs text-slate-600 dark:text-slate-300 italic" id="level-reward-msg"></p>
                </div>
                <button onclick="closeLevelUp()" class="w-full py-3 bg-slate-900 dark:bg-white text-white dark:text-black font-bold rounded-xl hover:opacity-90 transition shadow-lg min-h-[44px]">CONTINUAR ESTUDANDO</button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[180] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="bg-white dark:bg-dark-900 w-full max-w-lg h-[85vh] rounded-3xl shadow-2xl border border-slate-200 dark:border-white/10 flex flex-col overflow-hidden animate-slide-up relative">
            
            <div class="p-6 bg-slate-50 dark:bg-dark-800 border-b border-slate-100 dark:border-white/5 relative">
                <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 p-2">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                
                <div class="flex flex-col items-center">
                    <div class="relative group cursor-pointer mb-3" onclick="alert('Funcionalidade de upload em desenvolvimento!')">
                        <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg overflow-hidden border-4 border-white dark:border-dark-900">
                            <span id="profile-avatar-char">E</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="profile-name-display">Estudante</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400" id="profile-email-display">email@exemplo.com</p>
                </div>

                <div class="flex mt-6 border-b border-slate-200 dark:border-white/10">
                    <button onclick="switchProfileTab('personal')" class="profile-tab active flex-1 pb-3 text-sm font-medium text-center" id="tab-btn-personal">Perfil</button>
                    <button onclick="switchProfileTab('security')" class="profile-tab flex-1 pb-3 text-sm font-medium text-center" id="tab-btn-security">Seguran√ßa</button>
                    <button onclick="switchProfileTab('journey')" class="profile-tab flex-1 pb-3 text-sm font-medium text-center" id="tab-btn-journey">Jornada</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-dark-900">
                <div id="tab-content-personal" class="space-y-6">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Nome de Exibi√ß√£o</label>
                        <div class="flex gap-2">
                            <input type="text" id="edit-profile-name" class="flex-1 bg-slate-100 dark:bg-dark-800 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="Seu nome">
                            <button onclick="saveProfileName()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-xl font-bold text-sm transition-colors">Salvar</button>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-900/30">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-600 dark:text-blue-400">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase">N√≠vel Atual</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white" id="profile-rank-display">Iniciante</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-content-security" class="hidden space-y-6">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">E-mail de Acesso</label>
                        <input type="text" id="edit-profile-email" class="w-full bg-slate-100 dark:bg-dark-800 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-slate-500 dark:text-slate-400 cursor-not-allowed" disabled>
                        <p class="text-[10px] text-slate-400 mt-2">Para alterar o e-mail, entre em contato com o suporte.</p>
                    </div>
                    
                    <div class="pt-4 border-t border-slate-100 dark:border-white/5">
                        <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-3">Senha</h4>
                        <button onclick="handlePasswordResetProfile()" class="w-full flex items-center justify-center gap-2 py-3 border border-slate-200 dark:border-white/10 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-white/5 transition font-medium text-sm">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
                            Enviar e-mail de redefini√ß√£o
                        </button>
                    </div>
                </div>

                <div id="tab-content-journey" class="hidden space-y-6">
                    <div class="flex gap-4">
                        <div class="flex-1 bg-slate-50 dark:bg-dark-800 p-3 rounded-xl border border-slate-200 dark:border-white/5 text-center">
                            <div class="text-[10px] text-slate-400 uppercase font-bold">N√≠vel</div>
                            <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="profile-level-num">1</div>
                        </div>
                        <div class="flex-1 bg-slate-50 dark:bg-dark-800 p-3 rounded-xl border border-slate-200 dark:border-white/5 text-center">
                            <div class="text-[10px] text-slate-400 uppercase font-bold">XP Total</div>
                            <div class="text-xl font-bold text-purple-600 dark:text-purple-400" id="profile-xp-num">0</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Pr√≥ximos Passos</h4>
                        <div class="space-y-0 relative pl-4 border-l-2 border-slate-200 dark:border-white/10" id="profile-next-levels">
                            </div>
                    </div>
                </div>

            </div>

            <div class="p-4 border-t border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-dark-800">
                <button onclick="handleLogout()" class="w-full py-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold rounded-xl hover:bg-red-100 dark:hover:bg-red-900/30 transition text-sm flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Sair da Conta
                </button>
            </div>
        </div>
    </div>

    <script>
        const XP_PER_TASK = 150;
        const XP_PER_LEVEL = 350;
        const XP_LOGIN_BONUS = 50;
        const XP_PERFECT_DAY = 200; 
        const apiKey = "AIzaSyAYo8mXtLUgyzUH_RuwbaiYC0hwiK191us";

        const ranksList = [
            "Iniciante", "Estudante", "Dedicado", "Focado", "Avan√ßado", "Analista", 
            "Pesquisador", "Especialista", "Mestre", "Doutor", "S√°bio", 
            "Erudito", "Vision√°rio", "Luminar", "Mentor", "Gr√£o-Mestre", 
            "Catedr√°tico", "Excel√™ncia", "Lenda Viva", "Supremo"
        ];

        const levelRewards = [
            "A const√¢ncia √© a chave do aprendizado.",
            "Voc√™ desbloqueou uma nova perspectiva de estudo.",
            "Sua disciplina est√° criando ra√≠zes fortes.", 
            "O conhecimento se constr√≥i tijolo por tijolo.",
            "Voc√™ agora ret√©m informa√ß√µes com mais facilidade.",
            "Sua mente est√° se tornando uma biblioteca.",
            "Descanse, mas mantenha o h√°bito.",
            "A vit√≥ria ama a prepara√ß√£o diligente.",
            "Voc√™ √© o autor da sua pr√≥pria hist√≥ria.",
            "O edital √© apenas um guia, voc√™ √© o explorador."
        ];

        // --- FULL SCHEDULE DATA ---
        const scheduleData = [
            // SEMANA 1
            { date: "2026-02-02", week: 1, day: "Segunda", items: [{ id: "s1_seg_1", type: "red", subj: "Dir. Adm", desc: "Item 4: Lei 9.784/99 (Processo Adm e √ìrg√£os)" }, { id: "s1_seg_2", type: "blue", subj: "Portugu√™s", desc: "Itens 1 e 2: Leitura, Interpreta√ß√£o e Tipologia" }] },
            { date: "2026-02-03", week: 1, day: "Ter√ßa", items: [{ id: "s1_ter_1", type: "red", subj: "Dir. Adm", desc: "Item 10: Dec-Lei 200/67 (Org. Federal)" }, { id: "s1_ter_2", type: "gray", subj: "L√≥gica", desc: "Item 18: Estruturas L√≥gicas e Diagramas" }] },
            { date: "2026-02-04", week: 1, day: "Quarta", items: [{ id: "s1_qua_1", type: "red", subj: "Adm. P√∫b", desc: "Item 5: Agentes P√∫blicos (Cargos e Fun√ß√µes)" }, { id: "s1_qua_2", type: "blue", subj: "Portugu√™s", desc: "Item 3: Sem√¢ntica e Significa√ß√£o das Palavras" }] },
            { date: "2026-02-05", week: 1, day: "Quinta", items: [{ id: "s1_qui_1", type: "red", subj: "Leg. BA", desc: "Item 12: Lei 13.204/14 (Est. Organizacional)" }, { id: "s1_qui_2", type: "red", subj: "Leg. BA", desc: "Itens 13 e 14: Leis 10.549 e 12.212 (Executivo)" }] },
            { date: "2026-02-06", week: 1, day: "Sexta", items: [{ id: "s1_sex_1", type: "green", subj: "Gest√£o", desc: "Item 11: Dec. 9.739/19 (Efici√™ncia/Inova√ß√£o)" }, { id: "s1_sex_2", type: "red", subj: "Const.", desc: "Item 6: Princ√≠pios LIMPE + Quest√µes" }] },
            { date: "2026-02-07", week: 1, day: "S√°bado", items: [{ id: "s1_sab", type: "orange", subj: "Revis√£o", desc: "Resumo Geral + 40 Quest√µes IBFC" }] },
            { date: "2026-02-08", week: 1, day: "Domingo", items: [{ id: "s1_dom", type: "gray", subj: "Descanso", desc: "Descanso Estrat√©gico e Mental" }] },
            
            // SEMANA 2
            { date: "2026-02-09", week: 2, day: "Segunda", items: [{ id: "s2_seg_1", type: "red", subj: "CF/88", desc: "Itens 7 e 15: Educa√ß√£o na CF + Dir. Subjetivo" }, { id: "s2_seg_2", type: "blue", subj: "Portugu√™s", desc: "Item 4: Pontua√ß√£o e Sinais Gr√°ficos" }] },
            { date: "2026-02-10", week: 2, day: "Ter√ßa", items: [{ id: "s2_ter_1", type: "pink", subj: "LDB", desc: "Item 13: LDB (Sistemas de Ensino)" }, { id: "s2_ter_2", type: "purple", subj: "L√≥gica", desc: "Item 18: Argumenta√ß√£o e Dedu√ß√£o" }] },
            { date: "2026-02-11", week: 2, day: "Quarta", items: [{ id: "s2_qua_1", type: "pink", subj: "LDB", desc: "Item 1: LDB (Diretrizes Nacionais)" }, { id: "s2_qua_2", type: "pink", subj: "Pedagogia", desc: "Item 3: Projeto Pol√≠tico Pedag√≥gico (PPP)" }] },
            { date: "2026-02-12", week: 2, day: "Quinta", items: [{ id: "s2_qui_1", type: "pink", subj: "Pedagogia", desc: "Item 2: Concep√ß√£o Hist√≥rico-Cr√≠tica da Educa√ß√£o" }, { id: "s2_qui_2", type: "pink", subj: "LDB", desc: "Item 16: Resolu√ß√µes CNE (Diretrizes/Supervis√£o)" }] },
            { date: "2026-02-13", week: 2, day: "Sexta", items: [{ id: "s2_sex_1", type: "pink", subj: "LDB", desc: "Item 1: Res. CNE/CP 1/2021 (Diretrizes EPT)" }, { id: "s2_sex_2", type: "blue", subj: "Portugu√™s", desc: "Itens 1-4: Sintaxe B√°sica Aplicada ao Texto" }] },
            { date: "2026-02-14", week: 2, day: "S√°bado", items: [{ id: "s2_sab", type: "orange", subj: "Revis√£o", desc: "LDB + PPP + Mapa Mental da Educa√ß√£o" }] },
            { date: "2026-02-15", week: 2, day: "Domingo", items: [{ id: "s2_dom", type: "gray", subj: "Descanso", desc: "Descanso Estrat√©gico" }] },

            // SEMANA 3
            { date: "2026-02-16", week: 3, day: "Segunda", items: [{ id: "s3_seg_1", type: "cyan", subj: "ECA", desc: "Item 14: ECA (Direito √† Educa√ß√£o)" }, { id: "s3_seg_2", type: "indigo", subj: "Social", desc: "Item 4: √çndices de Pobreza e Projetos Sociais" }] },
            { date: "2026-02-17", week: 3, day: "Ter√ßa", items: [{ id: "s3_ter_1", type: "indigo", subj: "Social", desc: "Item 4: Dec. BA 12.830/11 (Pobreza)" }, { id: "s3_ter_2", type: "purple", subj: "L√≥gica", desc: "Item 18: L√≥gica Espacial e Temporal" }] },
            { date: "2026-02-18", week: 3, day: "Quarta", items: [{ id: "s3_qua_1", type: "indigo", subj: "Social", desc: "Itens 5, 7 e 8: Dec. 4.564, Res. 01/21 e 03/25" }, { id: "s3_qua_2", type: "indigo", subj: "Social", desc: "Item 6: Lei 14.945/24 + Revis√£o ECA" }] },
            { date: "2026-02-19", week: 3, day: "Quinta", items: [{ id: "s3_qui_1", type: "teal", subj: "Rev. Adm", desc: "Revis√£o Ativa: Direito Adm (Conte√∫do Sem 1)" }, { id: "s3_qui_2", type: "blue", subj: "Rev. Port", desc: "Revis√£o Ativa: Portugu√™s (Refazer erros)" }] },
            { date: "2026-02-20", week: 3, day: "Sexta", items: [{ id: "s3_sex_1", type: "violet", subj: "Contexto", desc: "Itens 1 e 4: Realidade BR e Desafios Educ." }, { id: "s3_sex_2", type: "purple", subj: "L√≥gica", desc: "Item 18: Treino de Psicot√©cnico" }] },
            { date: "2026-02-21", week: 3, day: "S√°bado", items: [{ id: "s3_sab", type: "orange", subj: "Simulado", desc: "SIMULADO PARCIAL (4h): Adm + LDB + Portugu√™s" }] },
            { date: "2026-02-22", week: 3, day: "Domingo", items: [{ id: "s3_dom", type: "gray", subj: "Descanso", desc: "Descanso e An√°lise do Simulado" }] },

            // SEMANA 4
            { date: "2026-02-23", week: 4, day: "Segunda", items: [{ id: "s4_seg_1", type: "fuchsia", subj: "Igualdade", desc: "Item 3: Est. Igualdade Racial (Lei 12.288/10)" }, { id: "s4_seg_2", type: "red", subj: "CF/88", desc: "Item 1: CF/88 Art. 1¬∫ ao 5¬∫ (Direitos Fundamentais)" }] },
            { date: "2026-02-24", week: 4, day: "Ter√ßa", items: [{ id: "s4_ter_1", type: "fuchsia", subj: "Igualdade", desc: "Item 4: Est. Racial BA (Lei 13.182/14)" }, { id: "s4_ter_2", type: "fuchsia", subj: "Igualdade", desc: "Itens 5 e 12: Lei 7.716/89 e Lei Ca√≥ 7.437/85" }] },
            { date: "2026-02-25", week: 4, day: "Quarta", items: [{ id: "s4_qua_1", type: "amber", subj: "Hist√≥ria", desc: "Item 15: Lei 10.639/03 (Hist√≥ria Afro)" }, { id: "s4_qua_2", type: "fuchsia", subj: "Const. BA", desc: "Item 2: Const. BA Cap. XXIII 'Do Negro'" }] },
            { date: "2026-02-26", week: 4, day: "Quinta", items: [{ id: "s4_qui_1", type: "amber", subj: "Hist√≥ria", desc: "Item 16: Lei 11.645/08 (Hist√≥ria Ind√≠gena)" }, { id: "s4_qui_2", type: "sky", subj: "Intl", desc: "Item 6: Conv. Int. Elim. Discrim. Racial" }] },
            { date: "2026-02-27", week: 4, day: "Sexta", items: [{ id: "s4_sex_1", type: "red", subj: "Dir. Penal", desc: "Itens 9 e 10: Inj√∫ria (CP) e Tortura (9.455/97)" }, { id: "s4_sex_2", type: "red", subj: "Dir. Penal", desc: "Item 11: Lei de Genoc√≠dio (2.889/56)" }] },
            { date: "2026-02-28", week: 4, day: "S√°bado", items: [{ id: "s4_sab", type: "orange", subj: "Intensivo", desc: "INTENSIVO (4h): 50 Quest√µes s√≥ sobre Legisla√ß√£o Racial/Humanos" }] },
            { date: "2026-03-01", week: 4, day: "Domingo", items: [{ id: "s4_dom", type: "gray", subj: "Descanso", desc: "Descanso Mental" }] },

            // SEMANA 5
            { date: "2026-03-02", week: 5, day: "Segunda", items: [{ id: "s5_seg_1", type: "rose", subj: "G√™nero", desc: "Item 8: Lei Maria da Penha (11.340/06)" }, { id: "s5_seg_2", type: "sky", subj: "Intl", desc: "Item 7: Conv. Int. Elim. Discrim. Mulher" }] },
            { date: "2026-03-03", week: 5, day: "Ter√ßa", items: [{ id: "s5_ter_1", type: "lime", subj: "Profiss√£o", desc: "Item 2: Lei 4.769/65 (T√©c. em Adm)" }, { id: "s5_ter_2", type: "lime", subj: "Profiss√£o", desc: "Item 3: Forma√ß√£o (Dec. 5.154 e Res. CNE 6)" }] },
            { date: "2026-03-04", week: 5, day: "Quarta", items: [{ id: "s5_qua_1", type: "purple", subj: "L√≥gica", desc: "Item 18: L√≥gica (Provas Anteriores IBFC)" }, { id: "s5_qua_2", type: "slate", subj: "Info", desc: "Item 17: Inform√°tica (Gest√£o de arquivos)" }] },
            { date: "2026-03-05", week: 5, day: "Quinta", items: [{ id: "s5_qui_1", type: "blue", subj: "Geral", desc: "Portugu√™s (Provas Anteriores)" }, { id: "s5_qui_2", type: "rose", subj: "Revis√£o", desc: "Leis da Mulher e Profiss√£o" }] },
            { date: "2026-03-06", week: 5, day: "Sexta", items: [{ id: "s5_sex_1", type: "violet", subj: "Contexto", desc: "Itens 2 e 3: Atualidades/Globaliza√ß√£o" }, { id: "s5_sex_2", type: "gray", subj: "Livre", desc: "Tapar buracos de mat√©rias atrasadas" }] },
            { date: "2026-03-07", week: 5, day: "S√°bado", items: [{ id: "s5_sab", type: "orange", subj: "Simulado", desc: "SIMULADO GERAL 1 (4h): Todas as mat√©rias" }] },
            { date: "2026-03-08", week: 5, day: "Domingo", items: [{ id: "s5_dom", type: "gray", subj: "Descanso", desc: "Descanso Ativo" }] },

            // SEMANA 6
            { date: "2026-03-09", week: 6, day: "Segunda", items: [{ id: "s6_seg_1", type: "teal", subj: "Rev. Adm", desc: "Direito Administrativo (Itens 4-6, 10-12)" }, { id: "s6_seg_2", type: "teal", subj: "Rev. LDB", desc: "LDB (Itens 1-3)" }] },
            { date: "2026-03-10", week: 6, day: "Ter√ßa", items: [{ id: "s6_ter_1", type: "teal", subj: "Rev. Adm", desc: "Direito Administrativo (Itens 4-6, 10-12) - Parte 2" }, { id: "s6_ter_2", type: "teal", subj: "Rev. LDB", desc: "LDB (Itens 1-3) - Quest√µes" }] },
            { date: "2026-03-11", week: 6, day: "Quarta", items: [{ id: "s6_qua_1", type: "rose", subj: "Rev. Racial", desc: "Legisla√ß√£o Racial (Todos os itens)" }, { id: "s6_qua_2", type: "rose", subj: "Rev. G√™nero", desc: "Legisla√ß√£o de G√™nero (Todos os itens)" }] },
            { date: "2026-03-12", week: 6, day: "Quinta", items: [{ id: "s6_qui_1", type: "rose", subj: "Rev. Racial", desc: "Legisla√ß√£o Racial - Quest√µes" }, { id: "s6_qui_2", type: "rose", subj: "Rev. G√™nero", desc: "Legisla√ß√£o de G√™nero - Quest√µes" }] },
            { date: "2026-03-13", week: 6, day: "Sexta", items: [{ id: "s6_sex_1", type: "blue", subj: "Rev. Port", desc: "Revis√£o Portugu√™s (Foco IBFC)" }, { id: "s6_sex_2", type: "purple", subj: "Rev. L√≥gica", desc: "Revis√£o L√≥gica (Item 18)" }] },
            { date: "2026-03-14", week: 6, day: "S√°bado", items: [{ id: "s6_sab", type: "blue", subj: "Rev. Port", desc: "Bateria Portugu√™s" }, { id: "s6_sab_2", type: "purple", subj: "Rev. L√≥gica", desc: "Bateria L√≥gica" }] },
            { date: "2026-03-15", week: 6, day: "Domingo", items: [{ id: "s6_dom", type: "gray", subj: "Descanso", desc: "Recupera√ß√£o Mental" }] },

            // SEMANA 7 - SEMANA DE GUERRA
            { date: "2026-03-16", week: 7, day: "Segunda", items: [{ id: "s7_seg_1", type: "orange", subj: "Guerra", desc: "Bateria 50 Quest√µes: Adm + LDB" }, { id: "s7_seg_2", type: "emerald", subj: "Lei Seca", desc: "Leitura da Lei Seca (Adm)" }] },
            { date: "2026-03-17", week: 7, day: "Ter√ßa", items: [{ id: "s7_ter_1", type: "orange", subj: "Guerra", desc: "Bateria 50 Quest√µes: Igualdade + G√™nero" }, { id: "s7_ter_2", type: "emerald", subj: "Lei Seca", desc: "Leitura da Lei Seca (Racial/G√™nero)" }] },
            { date: "2026-03-18", week: 7, day: "Quarta", items: [{ id: "s7_qua_1", type: "orange", subj: "Guerra", desc: "Bateria 50 Quest√µes: Portugu√™s + L√≥gica" }, { id: "s7_qua_2", type: "emerald", subj: "Lei Seca", desc: "Revis√£o de F√≥rmulas L√≥gicas" }] },
            { date: "2026-03-19", week: 7, day: "Quinta", items: [{ id: "s7_qui_1", type: "orange", subj: "Guerra", desc: "Bateria 50 Quest√µes: Conhecimentos Gerais" }, { id: "s7_qui_2", type: "emerald", subj: "Lei Seca", desc: "Leitura da Lei Seca (ECA/LDB)" }] },
            { date: "2026-03-20", week: 7, day: "Sexta", items: [{ id: "s7_sex_1", type: "orange", subj: "Guerra", desc: "Bateria 50 Quest√µes: Mistas Dif√≠ceis" }, { id: "s7_sex_2", type: "emerald", subj: "Lei Seca", desc: "Pontos Fracos" }] },
            { date: "2026-03-21", week: 7, day: "S√°bado", items: [{ id: "s7_sab", type: "orange", subj: "Simulado", desc: "SIMULADO CRONOMETRADO (Sem celular, apenas √°gua e caneta)" }] },
            { date: "2026-03-22", week: 7, day: "Domingo", items: [{ id: "s7_dom", type: "gray", subj: "Descanso", desc: "Descanso Absoluto" }] },

            // SEMANA 8 - A VIT√ìRIA
            { date: "2026-03-23", week: 8, day: "Segunda", items: [{ id: "s8_seg_1", type: "emerald", subj: "Lei Seca", desc: "Revis√£o LDB e ECA (Leitura din√¢mica da lei seca)" }, { id: "s8_seg_2", type: "rose", subj: "Decoreba", desc: "Prazos e N√∫meros Importantes" }] },
            { date: "2026-03-24", week: 8, day: "Ter√ßa", items: [{ id: "s8_ter_1", type: "fuchsia", subj: "Decoreba", desc: "Revis√£o Igualdade Racial/G√™nero (Prazos e Penas)" }, { id: "s8_ter_2", type: "emerald", subj: "Lei Seca", desc: "Leis 10.639 e 11.645" }] },
            { date: "2026-03-25", week: 8, day: "Quarta", items: [{ id: "s8_qua_1", type: "blue", subj: "Rev. Port", desc: "Portugu√™s (Crase/Concord√¢ncia)" }, { id: "s8_qua_2", type: "indigo", subj: "F√≥rmulas", desc: "L√≥gica (Revis√£o Final de F√≥rmulas)" }] },
            { date: "2026-03-26", week: 8, day: "Quinta", items: [{ id: "s8_qui_1", type: "red", subj: "Rev. Adm", desc: "Adm. P√∫blica (LIMPE e Estruturas)" }, { id: "s8_qui_2", type: "emerald", subj: "Lei Seca", desc: "Constitui√ß√£o Federal (Art 5¬∫)" }] },
            { date: "2026-03-27", week: 8, day: "Sexta", items: [{ id: "s8_sex_1", type: "slate", subj: "Leve", desc: "Leitura leve de Atualidades. Nada novo." }, { id: "s8_sex_2", type: "slate", subj: "Pr√©-Prova", desc: "Organizar material, local de prova e canetas." }] },
            { date: "2026-03-28", week: 8, day: "S√°bado", items: [{ id: "s8_sab", type: "gray", subj: "Descanso", desc: "Descanso ativo. O trabalho foi feito." }] },
            { date: "2026-03-29", week: 8, day: "Domingo", items: [{ id: "s8_dom", type: "yellow", subj: "DIA DA PROVA", desc: "Boa sorte! Voc√™ est√° preparado." }] }
        ];

        const subjectMeta = {
            'Dir. Adm': { color: 'red', icon: '‚öñÔ∏è' },
            'Adm. P√∫b': { color: 'orange', icon: 'üèõÔ∏è' },
            'Leg. BA': { color: 'yellow', icon: 'üìú' },
            'Const.': { color: 'red', icon: '‚öñÔ∏è' },
            'CF/88': { color: 'red', icon: '‚öñÔ∏è' },
            'Dir. Penal': { color: 'red', icon: 'üëÆ' },
            'Gest√£o': { color: 'emerald', icon: 'üìä' },
            'Portugu√™s': { color: 'blue', icon: '‚úçÔ∏è' },
            'L√≥gica': { color: 'purple', icon: 'üß†' },
            'LDB': { color: 'pink', icon: 'üéì' },
            'Pedagogia': { color: 'pink', icon: 'üè´' },
            'ECA': { color: 'cyan', icon: 'üë∂' },
            'Social': { color: 'indigo', icon: 'üåç' },
            'Igualdade': { color: 'fuchsia', icon: 'ü§ù' },
            'Hist√≥ria': { color: 'amber', icon: 'üè∫' },
            'Intl': { color: 'sky', icon: 'üåê' },
            'G√™nero': { color: 'rose', icon: 'üë©' },
            'Profiss√£o': { color: 'lime', icon: 'üíº' },
            'Info': { color: 'slate', icon: 'üíª' },
            'Revis√£o': { color: 'teal', icon: 'üîÑ' },
            'Simulado': { color: 'orange', icon: 'üìù' },
            'Geral': { color: 'gray', icon: 'üìö' },
            'Contexto': { color: 'violet', icon: 'üóûÔ∏è' },
            'Guerra': { color: 'orange', icon: '‚öîÔ∏è' },
            'Lei Seca': { color: 'emerald', icon: 'üìñ' },
            'F√≥rmulas': { color: 'indigo', icon: '‚ûó' },
            'Decoreba': { color: 'rose', icon: 'üß†' },
            'Leve': { color: 'slate', icon: 'üçÉ' },
            'Pr√©-Prova': { color: 'slate', icon: 'üßò' },
            'DIA DA PROVA': { color: 'yellow', icon: 'üèÜ' },
            'Descanso': { color: 'gray', icon: 'üí§' },
            'Rev. Adm': { color: 'red', icon: 'üîÑ' },
            'Rev. Port': { color: 'blue', icon: 'üîÑ' },
            'Rev. LDB': { color: 'pink', icon: 'üîÑ' },
            'Rev. Racial': { color: 'fuchsia', icon: 'üîÑ' },
            'Rev. G√™nero': { color: 'rose', icon: 'üîÑ' },
            'Rev. L√≥gica': { color: 'purple', icon: 'üîÑ' },
            'Const. BA': { color: 'yellow', icon: 'üìú' },
            'Livre': { color: 'gray', icon: 'üÜì' },
            'Intensivo': { color: 'orange', icon: 'üî•' }
        };

        const syllabusDB = scheduleData.flatMap(day => 
            day.items.map(item => ({
                id: item.id,
                cat: item.subj,
                title: `${day.day} - ${item.desc}`,
                text: `Conte√∫do referente a ${item.subj}: ${item.desc}. Este t√≥pico faz parte da ${day.week}¬™ semana de estudos. Foco total na resolu√ß√£o de quest√µes e leitura da lei seca se aplic√°vel.`
            }))
        );

        const achievementsList = [
            { id: 'perfect_day_counter', title: 'Dias Perfeitos', desc: 'Dias em que voc√™ completou 100% das tarefas.', icon: 'üåü', type: 'counter', max: 55, progress: (s) => s.perfectDays, req: (s) => s.perfectDays >= 1 },
            { id: 'first_step_counter', title: 'Dias de Estudo', desc: 'Dias em que voc√™ realizou pelo menos uma tarefa.', icon: 'üìÖ', type: 'counter', max: 55, progress: (s) => s.distinctDaysCount, req: (s) => s.distinctDaysCount >= 1 },
            { id: 'streak_3', title: 'Foco Inicial', desc: 'Mantenha uma sequ√™ncia de 3 dias.', icon: 'üî•', max: 3, progress: (s) => s.streak, req: (s) => s.streak >= 3 },
            { id: 'streak_7', title: 'Consist√™ncia', desc: 'Mantenha uma sequ√™ncia de 7 dias.', icon: 'üöÄ', max: 7, progress: (s) => s.streak, req: (s) => s.streak >= 7 },
            { id: 'level_5', title: 'Estudante N√≠vel 5', desc: 'Alcance o n√≠vel 5.', icon: '‚≠ê', max: 5, progress: (s) => s.level, req: (s) => s.level >= 5 },
            { id: 'scholar_1', title: 'Leitor I', desc: 'Complete 10 tarefas.', icon: 'üìö', max: 10, progress: (s) => s.totalDone, req: (s) => s.totalDone >= 10 },
            { id: 'legislator', title: 'Jurista', desc: 'Complete 10 tarefas de Direito.', icon: '‚öñÔ∏è', max: 10, progress: (s) => s.subjectCounts['Direito'] || 0, req: (s) => (s.subjectCounts['Direito'] || 0) >= 10 }
        ];

        // --- AUTH & USER LOGIC ---
        let isRegistering = false;
        let currentUserObject = null;

        window.togglePasswordVisibility = () => {
            const input = document.getElementById('auth-password');
            const eyeIcon = document.getElementById('eye-icon');
            const eyeOffIcon = document.getElementById('eye-off-icon');
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                input.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        };

        window.validateEmailLive = (input) => {
            const email = input.value;
            const errorEl = document.getElementById('error-email');
            const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            if (email.length > 0) {
                if (!isValid) {
                    input.classList.add('border-red-500');
                    input.classList.remove('border-slate-700', 'focus:border-neon-blue');
                    errorEl.classList.remove('hidden');
                } else {
                    input.classList.remove('border-red-500');
                    input.classList.add('border-slate-700', 'focus:border-neon-blue');
                    errorEl.classList.add('hidden');
                }
            } else {
                clearError(input);
            }
        };

        window.checkPasswordStrength = (password) => {
            if (!isRegistering) return; 
            const meterContainer = document.getElementById('password-strength-container');
            if(password.length === 0) {
                meterContainer.classList.remove('active');
                return;
            }
            meterContainer.classList.add('active');
            let score = 0;
            if (password.length > 5) score++;
            if (password.length > 8) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            const segs = [1,2,3,4].map(i => document.getElementById(`strength-${i}`));
            segs.forEach(el => el.className = 'flex-1 rounded-full bg-slate-700 transition-colors duration-300');
            
            let colorClass = 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]';
            if (score > 2) colorClass = 'bg-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.6)]';
            if (score > 3) colorClass = 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]';

            for(let i=0; i<score; i++) segs[i].className = `flex-1 rounded-full ${colorClass} transition-colors duration-300`;
            
            const text = document.getElementById('strength-text');
            text.innerText = `For√ßa: ${score > 3 ? 'Forte' : (score > 2 ? 'M√©dia' : 'Fraca')}`;
            text.className = `text-[10px] text-right mt-1 font-bold ${score > 3 ? 'text-green-500' : (score > 2 ? 'text-yellow-500' : 'text-red-500')}`;
        };

        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            const nameContainer = document.getElementById('field-name-container');
            const authBtn = document.getElementById('auth-btn');
            const toggleText = document.getElementById('auth-toggle-text');
            const forgotLink = document.getElementById('forgot-link');
            
            clearAllErrors();
            
            if (isRegistering) {
                nameContainer.classList.add('active');
                authBtn.innerHTML = `<span>Criar Minha Conta</span>`;
                toggleText.innerHTML = `J√° tem conta? <button onclick="toggleAuthMode()" class="text-neon-purple font-bold ml-1 p-2">Login</button>`;
                forgotLink.classList.add('invisible');
            } else {
                nameContainer.classList.remove('active');
                authBtn.innerHTML = `<span>Entrar na Plataforma</span>`;
                toggleText.innerHTML = `Sem conta? <button onclick="toggleAuthMode()" class="text-neon-purple font-bold ml-1 p-2">Cadastre-se</button>`;
                forgotLink.classList.remove('invisible');
            }
        };

        function clearAllErrors() {
            document.querySelectorAll('input').forEach(i => i.classList.remove('input-error', 'border-red-500'));
            document.querySelectorAll('p[id^="error-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById('auth-global-error').classList.add('hidden');
        }

        function clearError(input) {
            input.classList.remove('input-error');
            const errEl = document.getElementById('error-' + input.id.split('-')[1]);
            if(errEl) errEl.classList.add('hidden');
        }

        function showError(fieldId, msg) {
            const input = document.getElementById(fieldId);
            const errEl = document.getElementById('error-' + fieldId.split('-')[1]);
            input.classList.add('input-error');
            if(errEl) {
                errEl.querySelector('span').innerText = msg;
                errEl.classList.remove('hidden');
            }
        }

        window.handleAuth = async (e) => {
            e.preventDefault();
            clearAllErrors();
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value.trim();
            
            let isValid = true;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('auth-email', 'E-mail inv√°lido.'); isValid = false; }
            if (password.length < 6) { showError('auth-password', 'M√≠nimo 6 caracteres.'); isValid = false; }
            if (isRegistering && name.length < 3) { showError('auth-name', 'Digite seu nome.'); isValid = false; }

            if (!isValid) return;

            const btn = document.getElementById('auth-btn');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            try {
                if(window.auth) {
                    if (isRegistering) {
                        const cred = await window.createUserWithEmailAndPassword(window.auth, email, password);
                        await window.updateProfile(cred.user, { displayName: name });
                        window.handleLoginData(cred.user);
                    } else {
                        const cred = await window.signInWithEmailAndPassword(window.auth, email, password);
                        window.handleLoginData(cred.user);
                    }
                }
            } catch (error) {
                let msg = "Erro desconhecido.";
                if (error.code.includes('password')) showError('auth-password', 'Senha incorreta.');
                else if (error.code.includes('email') || error.code === 'auth/user-not-found') showError('auth-email', 'E-mail incorreto.');
                else {
                    document.getElementById('global-error-text').innerText = "Erro de autentica√ß√£o. Tente novamente.";
                    document.getElementById('auth-global-error').classList.remove('hidden');
                }
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
            }
        };

        window.handleGuestLogin = async () => {
            try {
                if(window.auth) await window.signInAnonymously(window.auth);
                window.handleLoginData({ uid: 'guest', displayName: 'Visitante' });
            } catch (e) { console.error(e); }
        };

        window.handleLogout = async () => {
            try {
                if(window.auth) await window.signOut(window.auth);
                location.reload();
            } catch(e) { console.error(e); }
        }

        // --- APP STATE ---
        let currentUser = null;
        let userProgress = []; 
        let userAchievements = []; 
        let extraXP = 0; 
        let perfectDaysCount = 0;
        let completionDates = {};
        let currentLibFilter = 'Todos';
        let calendarDate = new Date('2026-02-02T00:00:00');
        let currentSelectedDate = '';
        let chartInstance = null;
        let currentTopicTitle = "";
        let currentTopicContext = "";
        const intelCache = {}; 

        window.handleLoginData = (user) => {
            currentUser = user.uid;
            currentUserObject = user;
            
            const name = user.displayName ? user.displayName.split(' ')[0] : 'Estudante';
            document.getElementById('header-name').innerText = name;
            document.getElementById('profile-avatar-char').innerText = (user.displayName || 'E').charAt(0).toUpperCase();
            
            document.getElementById('profile-name-display').innerText = user.displayName || 'Estudante';
            document.getElementById('profile-email-display').innerText = user.email || 'Convidado';
            document.getElementById('edit-profile-name').value = user.displayName || '';
            document.getElementById('edit-profile-email').value = user.email || '';

            const overlay = document.getElementById('login-overlay');
            if(overlay) {
                overlay.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => overlay.classList.add('hidden'), 500);
            }

            if(window.db) {
                const d = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'profiles', currentUser);
                window.onSnapshot(d, (snap) => {
                    const data = snap.exists() ? snap.data() : {};
                    userProgress = data.checkedItems || [];
                    userAchievements = data.achievements || [];
                    extraXP = data.extraXP || 0;
                    perfectDaysCount = data.perfectDaysCount || 0;
                    completionDates = data.completionDates || {};
                    initApp();
                });
            }
        }

        function saveData() {
            if(currentUser && window.db) {
                window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'profiles', currentUser), { 
                    checkedItems: userProgress,
                    achievements: userAchievements,
                    extraXP: extraXP,
                    perfectDaysCount: perfectDaysCount,
                    completionDates: completionDates
                }, { merge: true });
            }
        }

        function initApp() {
            renderDashboard();
            renderGamification();
            renderCalendar();
            renderRoadmap(); 
            renderAchievements();
            renderLibraryFilters();
            window.searchContent();
            updateChartTheme();
            
            const savedTheme = localStorage.getItem('theme') || 'system';
            setTheme(savedTheme);
        }

        function addXP(amount) { extraXP += amount; }
        
        function showToast(title, msg) {
            const toast = document.getElementById('achievement-toast');
            if (!toast) return;
            document.getElementById('toast-title').innerText = msg;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 4000);
        }

        window.switchView = (id) => {
            ['dashboard', 'schedule', 'library', 'edital', 'stats', 'achievements'].forEach(v => {
                const el = document.getElementById('view-'+v);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById('view-'+id);
            if (target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.nav-item[onclick*="${id}"]`).forEach(el => el.classList.add('active'));

            if(window.innerWidth < 768) {
                const sb = document.getElementById('main-sidebar');
                if(sb.classList.contains('sidebar-open')) window.toggleSidebar();
            }
        }

        window.toggleSidebar = () => {
            const sb = document.getElementById('main-sidebar');
            const ov = document.getElementById('mobile-overlay');
            if (sb) sb.classList.toggle('sidebar-open');
            if (ov) ov.classList.toggle('hidden');
        }
        
        window.toggleSidebarDesktop = () => {
             const sb = document.getElementById('main-sidebar');
             const main = document.querySelector('main');
             if(sb) {
                 if(sb.classList.contains('md:w-64')) {
                     sb.classList.remove('md:w-64'); sb.classList.add('md:w-20');
                     main.classList.remove('md:ml-64'); main.classList.add('md:ml-20');
                     document.querySelectorAll('.nav-label').forEach(el => el.classList.add('hidden'));
                     document.getElementById('logo-text').classList.add('hidden');
                 } else {
                     sb.classList.add('md:w-64'); sb.classList.remove('md:w-20');
                     main.classList.add('md:ml-64'); main.classList.remove('md:ml-20');
                     document.querySelectorAll('.nav-label').forEach(el => el.classList.remove('hidden'));
                     document.getElementById('logo-text').classList.remove('hidden');
                 }
             }
        }

        function scrollToTasks() {
            document.getElementById('task-section')?.scrollIntoView({ behavior: 'smooth' });
        }

        function renderDashboard() {
            const examDate = new Date('2026-03-29');
            const diff = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
            document.getElementById('header-countdown').innerText = diff > 0 ? diff : "HOJE";

            const total = scheduleData.reduce((acc, d) => acc + d.items.length, 0);
            const done = userProgress.length;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            
            const circle = document.getElementById('dash-circle-progress');
            if (circle) circle.style.strokeDashoffset = (2 * Math.PI * 40) * (1 - percent / 100);
            document.getElementById('dash-percent-text').innerText = `${percent}%`;
            document.getElementById('dash-completed-count').innerText = done;
            
            if(!currentSelectedDate) selectDate(new Date().toISOString().split('T')[0] > '2026-02-02' ? new Date().toISOString().split('T')[0] : '2026-02-02');
            else selectDate(currentSelectedDate);
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun"];
            document.getElementById('calendar-header-label').innerText = `${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDayIndex = firstDay.getDay(); 
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDayIndex);

            for (let i = 0; i < 35; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const dStr = d.toISOString().split('T')[0];
                const isSelected = dStr === currentSelectedDate;
                const tasks = scheduleData.find(s => s.date === dStr);
                const hasTask = tasks && tasks.items.length > 0;
                const isDone = hasTask && tasks.items.every(t => userProgress.includes(t.id));

                const cell = document.createElement('div');
                cell.className = `h-14 md:h-20 rounded-xl border ${isSelected ? 'border-purple-500 dark:border-neon-purple shadow-[0_0_10px_rgba(188,19,254,0.3)] bg-white dark:bg-white/10' : 'border-slate-100 dark:border-white/5 bg-white dark:bg-dark-800'} flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-white/5 transition relative`;
                cell.onclick = () => selectDate(dStr);

                let statusDot = '';
                if(hasTask) {
                    statusDot = isDone 
                        ? `<div class="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.8)]"></div>`
                        : `<div class="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>`;
                }

                cell.innerHTML = `
                    <span class="text-xs md:text-sm font-bold ${d.getMonth() === month ? 'text-slate-700 dark:text-white' : 'text-slate-300 dark:text-white/20'}">${d.getDate()}</span>
                    ${statusDot}
                `;
                grid.appendChild(cell);
            }
        }

        window.changeCalendarDate = (delta) => {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }

        window.selectDate = (dateStr) => {
            currentSelectedDate = dateStr;
            renderCalendar();
            
            const container = document.getElementById('today-container');
            if (!container) return;
            
            const data = scheduleData.find(d => d.date === dateStr);
            const dateObj = new Date(dateStr + 'T12:00:00');
            document.getElementById('selected-date-label').innerText = `${dateObj.getDate()}/${dateObj.getMonth()+1}`;
            document.getElementById('intel-date').innerText = dateStr;
            
            generateDailyBriefing(dateStr);

            let dailyTotal = 0;
            let dailyDone = 0;

            if(data && data.items.length > 0) {
                dailyTotal = data.items.length;
                dailyDone = data.items.filter(i => userProgress.includes(i.id)).length;
                
                container.innerHTML = data.items.map(item => {
                    const isChecked = userProgress.includes(item.id);
                    return `
                    <div class="flex items-center gap-4 p-4 rounded-2xl bg-white dark:bg-dark-900 border ${isChecked ? 'border-green-500/30' : 'border-slate-100 dark:border-white/5'} transition-all group hover:border-blue-400 dark:hover:border-neon-blue">
                        <div class="custom-checkbox relative w-6 h-6 shrink-0">
                            <label class="cursor-pointer block w-full h-full">
                                <input type="checkbox" class="sr-only" onchange="toggleItem('${item.id}')" ${isChecked ? 'checked' : ''}>
                                <div class="w-full h-full border-2 border-slate-300 dark:border-slate-600 rounded-lg transition-all bg-transparent"></div>
                            </label>
                        </div>
                        <div class="flex-1 min-w-0 cursor-pointer" onclick="openContentModal('${item.id}')">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-slate-100 dark:bg-white/10 text-slate-500 dark:text-slate-300 truncate">${item.subj}</span>
                                ${isChecked ? '<span class="text-[10px] text-green-500 font-bold hidden sm:inline">CONCLU√çDO +'+XP_PER_TASK+' XP</span>' : ''}
                            </div>
                            <p class="text-sm font-semibold text-slate-700 dark:text-white truncate group-hover:text-blue-500 dark:group-hover:text-neon-blue transition-colors ${isChecked ? 'line-through opacity-50' : ''}">${item.desc}</p>
                        </div>
                        <button onclick="openContentModal('${item.id}')" class="p-2 text-slate-300 hover:text-white hover:bg-slate-200 dark:hover:bg-white/10 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>`;
                }).join('');
            } else {
                container.innerHTML = `<div class="p-8 text-center text-slate-400 border-2 border-dashed border-slate-200 dark:border-white/5 rounded-2xl text-sm">Sem miss√µes para este dia.</div>`;
            }

            const percent = dailyTotal > 0 ? (dailyDone / dailyTotal) * 100 : 0;
            document.getElementById('daily-progress-bar').style.width = `${percent}%`;
            document.getElementById('daily-progress-text').innerText = `${dailyDone}/${dailyTotal} Completas`;
        }

        window.toggleItem = (id) => {
            if(userProgress.includes(id)) {
                userProgress = userProgress.filter(i => i !== id);
                delete completionDates[id];
            } else {
                userProgress.push(id);
                completionDates[id] = new Date().toISOString();
                const day = scheduleData.find(d => d.items.some(i => i.id === id));
                if(day && day.items.every(i => userProgress.includes(i.id))) {
                    perfectDaysCount++;
                    addXP(XP_PERFECT_DAY);
                    showToast("Dia Perfeito!", `+${XP_PERFECT_DAY} XP B√¥nus`);
                }
            }
            saveData();
            initApp(); 
        }

        function renderRoadmap() {
            const container = document.getElementById('full-schedule-container');
            if (!container) return;
            
            const weeks = {};
            scheduleData.forEach(d => {
                if(!weeks[d.week]) weeks[d.week] = [];
                weeks[d.week].push(d);
            });

            const today = new Date().toISOString().split('T')[0];
            let activeWeek = 1;
            for (const w in weeks) {
                const dates = weeks[w].map(d => d.date);
                if (today >= dates[0] && today <= dates[dates.length-1]) activeWeek = parseInt(w);
                else if (today > dates[dates.length-1]) activeWeek = parseInt(w) + 1;
            }
            if (activeWeek > 8) activeWeek = 8;

            let html = '';
            for (let i = 1; i <= 8; i++) {
                const weekData = weeks[i] || [];
                const weekItems = weekData.flatMap(d => d.items);
                const totalItems = weekItems.length;
                const doneItems = weekItems.filter(item => userProgress.includes(item.id)).length;
                const progress = totalItems > 0 ? (doneItems / totalItems) * 100 : 0;
                
                let statusClass = 'border-slate-200 dark:border-white/5 opacity-60 grayscale';
                let icon = 'üîí';
                let statusText = 'Bloqueado';
                let lineClass = 'bg-slate-200 dark:bg-white/5';

                if (i < activeWeek) {
                    statusClass = 'border-green-500/50 dark:border-green-500/30 bg-green-50/50 dark:bg-green-900/10';
                    icon = '‚úÖ';
                    statusText = 'Conclu√≠do';
                    lineClass = 'bg-green-500';
                } else if (i === activeWeek) {
                    statusClass = 'border-blue-500 dark:border-neon-blue shadow-[0_0_20px_rgba(59,130,246,0.15)] bg-white dark:bg-dark-800';
                    icon = 'üìç';
                    statusText = 'Em Progresso';
                    lineClass = 'bg-blue-500 animate-pulse';
                }

                html += `
                <div class="relative pl-8">
                    <div class="absolute left-[-5px] top-6 w-4 h-4 rounded-full border-2 border-white dark:border-dark-900 ${lineClass} z-10"></div>
                    
                    <div class="rounded-2xl border ${statusClass} p-4 md:p-5 transition-all hover:scale-[1.01]">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold uppercase tracking-wider ${i === activeWeek ? 'text-blue-600 dark:text-neon-blue' : 'text-slate-500'}">Fase 0${i}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-white/10 text-slate-500">${statusText}</span>
                                </div>
                                <h3 class="font-display font-bold text-base md:text-lg text-slate-900 dark:text-white">Semana ${i}</h3>
                            </div>
                            <div class="text-xl md:text-2xl">${icon}</div>
                        </div>
                        
                        <div class="w-full h-2 bg-slate-100 dark:bg-white/5 rounded-full overflow-hidden mb-4">
                            <div class="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-1000" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-xs text-right text-slate-500 mb-4">${doneItems}/${totalItems} Objetivos</div>

                        <div class="space-y-3">
                            ${weekData.map(day => `
                                <div class="flex flex-col sm:flex-row gap-1 sm:gap-3 text-sm">
                                    <span class="w-16 shrink-0 font-bold text-slate-400 text-xs py-1">${day.day.substr(0,3)}</span>
                                    <div class="flex-1 space-y-2">
                                        ${day.items.map(item => {
                                            const done = userProgress.includes(item.id);
                                            const meta = subjectMeta[item.subj] || { color: 'gray' };
                                            return `
                                            <div class="flex items-center gap-2 group cursor-pointer" onclick="openContentModal('${item.id}')">
                                                <div class="w-1.5 h-1.5 rounded-full ${done ? 'bg-green-500' : 'bg-slate-300 dark:bg-white/20'}"></div>
                                                <span class="${done ? 'text-slate-400 line-through' : 'text-slate-700 dark:text-slate-300'} group-hover:text-blue-500 transition-colors truncate text-xs md:text-sm">
                                                    <span class="font-bold text-[10px] px-1.5 py-0.5 rounded bg-${meta.color}-100 text-${meta.color}-700 dark:bg-${meta.color}-900/30 dark:text-${meta.color}-300 mr-1 hidden sm:inline">${item.subj}</span>
                                                    ${item.desc}
                                                </span>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function calculateStats() {
            const distinctDays = new Set();
            const subjectCounts = {};
            let weekendTasks = 0;
            scheduleData.forEach(d => {
                const isWeekend = d.day === 'S√°bado' || d.day === 'Domingo';
                d.items.forEach(item => {
                    if (userProgress.includes(item.id)) {
                        distinctDays.add(d.date);
                        let category = item.subj;
                        if (['Dir. Adm', 'Adm. P√∫b', 'Leg. BA', 'Const.', 'CF/88', 'Dir. Penal', 'Gest√£o', 'Const. BA'].includes(item.subj)) category = 'Direito';
                        if (['LDB', 'Pedagogia', 'ECA'].includes(item.subj)) category = 'Educa√ß√£o';
                        if (['Igualdade', 'Hist√≥ria', 'Social', 'Intl'].includes(item.subj)) category = 'Sociedade';
                        subjectCounts[category] = (subjectCounts[category] || 0) + 1;
                        if(isWeekend) weekendTasks++;
                    }
                });
            });
            return { distinctDaysCount: distinctDays.size, streak: distinctDays.size, subjectCounts, weekendTasks };
        }

        function renderGamification() {
            const taskXP = userProgress.length * XP_PER_TASK;
            const totalXP = taskXP + extraXP;
            const level = Math.floor(totalXP / XP_PER_LEVEL) + 1;
            const xpInLevel = totalXP % XP_PER_LEVEL;
            const progressPercent = (xpInLevel / XP_PER_LEVEL) * 100;

            document.getElementById('xp-bar').style.width = `${progressPercent}%`;
            document.getElementById('xp-text').innerText = `${xpInLevel} / ${XP_PER_LEVEL} XP`;
            document.getElementById('level-circle').innerText = level;
            
            const computedStats = calculateStats();
            document.getElementById('stat-xp').innerText = totalXP.toLocaleString();
            document.getElementById('stat-level').innerText = level;
            document.getElementById('stat-completed').innerText = userProgress.length;
            document.getElementById('stat-hours').innerText = (userProgress.length * 2) + 'h';
            
            const rankName = ranksList[Math.min(level - 1, ranksList.length - 1)];
            document.getElementById('stat-rank-text').innerText = rankName;
            
            const rankDisplay = document.getElementById('profile-rank-display');
            if(rankDisplay) rankDisplay.innerText = rankName; 
            
            document.getElementById('streak-count').innerText = computedStats.streak;

            const profileLevel = document.getElementById('profile-level-num');
            if(profileLevel) profileLevel.innerText = level;
            
            const profileXp = document.getElementById('profile-xp-num');
            if(profileXp) profileXp.innerText = totalXP;

            const historyBody = document.getElementById('history-table-body');
            const emptyState = document.getElementById('history-empty-state');
            if (historyBody) {
                const completedItems = [];
                scheduleData.forEach(d => d.items.forEach(item => {
                    if (userProgress.includes(item.id)) completedItems.push({ desc: item.desc, subj: item.subj, date: completionDates[item.id] ? new Date(completionDates[item.id]) : new Date(d.date) });
                }));
                completedItems.sort((a, b) => b.date - a.date);

                if (completedItems.length === 0) {
                    historyBody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    historyBody.innerHTML = completedItems.map(item => `
                        <tr class="border-b border-slate-100 dark:border-white/5 hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                            <td class="py-3 pl-2 max-w-[120px] md:max-w-[200px] truncate text-slate-700 dark:text-slate-300 font-medium" title="${item.desc}">${item.desc}</td>
                            <td class="py-3"><span class="text-[10px] font-bold uppercase px-2 py-1 rounded bg-slate-100 dark:bg-white/10 text-slate-500 dark:text-slate-400">${item.subj}</span></td>
                            <td class="py-3 text-right pr-2 text-slate-500 dark:text-slate-400 font-mono text-xs">${item.date.toLocaleDateString('pt-BR')}</td>
                        </tr>`).join('');
                }
            }
            checkAchievements(level, computedStats);
        }

        function checkAchievements(level, computedStats) {
            const stats = { level, streak: computedStats.streak, totalDone: userProgress.length, perfectDays: perfectDaysCount, subjectCounts: computedStats.subjectCounts, distinctDaysCount: computedStats.distinctDaysCount };
            let newUnlock = false;
            achievementsList.forEach(ach => {
                if (ach.type !== 'counter' && !userAchievements.includes(ach.id) && ach.req(stats)) {
                    userAchievements.push(ach.id);
                    showToast("Conquista Desbloqueada", ach.title);
                    newUnlock = true;
                }
            });
            if (newUnlock) saveData();
            renderAchievements(stats);
        }

        function renderAchievements(currentStats) {
            const grid = document.getElementById('achievements-grid');
            if (!grid) return;
            
            if (!currentStats) {
                const computed = calculateStats();
                const taskXP = userProgress.length * XP_PER_TASK;
                const totalXP = taskXP + extraXP;
                const level = Math.floor(totalXP / XP_PER_LEVEL) + 1;
                
                currentStats = { 
                    level: level, 
                    streak: computed.streak, 
                    totalDone: userProgress.length, 
                    perfectDays: perfectDaysCount,
                    subjectCounts: computed.subjectCounts,
                    distinctDaysCount: computed.distinctDaysCount,
                    weekendTasks: computed.weekendTasks
                };
            }
            
            grid.innerHTML = achievementsList.map(ach => {
                const unlocked = ach.type !== 'counter' && userAchievements.includes(ach.id);
                let progressBarHtml = '';
                if(ach.type === 'counter' || ach.max) {
                    const currentVal = ach.progress ? ach.progress(currentStats) : 0;
                    const percent = Math.min(100, (currentVal / ach.max) * 100);
                    progressBarHtml = `
                        <div class="w-full mt-3 h-1 bg-slate-100 dark:bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 transition-all duration-500" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-400 mt-1"><span>${currentVal}/${ach.max}</span></div>`;
                }
                const borderClass = unlocked ? 'border-yellow-400/50 dark:border-neon-gold/50 shadow-[0_0_10px_rgba(255,215,0,0.1)]' : 'border-slate-100 dark:border-white/5';
                const opacityClass = (unlocked || ach.type === 'counter') ? 'opacity-100' : 'opacity-70';

                return `
                <div class="bg-white dark:bg-dark-900 p-4 rounded-2xl border ${borderClass} ${opacityClass} flex flex-col items-center text-center transition-all relative overflow-hidden group">
                    <div class="text-3xl mb-2 grayscale-0">${ach.icon}</div>
                    <h4 class="font-bold text-slate-800 dark:text-white text-xs md:text-sm leading-tight">${ach.title}</h4>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 mt-1 leading-snug hidden sm:block">${ach.desc}</p>
                    ${progressBarHtml}
                </div>`;
            }).join('');
        }

        function getSubjectColorClass(subj) {
            const meta = subjectMeta[subj] || { color: 'gray' };
            const c = meta.color;
            const colorMap = {
                'red': 'text-red-700 bg-red-100 dark:text-red-300 dark:bg-red-900/30',
                'blue': 'text-blue-700 bg-blue-100 dark:text-blue-300 dark:bg-blue-900/30',
                'green': 'text-green-700 bg-green-100 dark:text-green-300 dark:bg-green-900/30',
                'purple': 'text-purple-700 bg-purple-100 dark:text-purple-300 dark:bg-purple-900/30',
                'yellow': 'text-yellow-700 bg-yellow-100 dark:text-yellow-300 dark:bg-yellow-900/30',
                'orange': 'text-orange-700 bg-orange-100 dark:text-orange-300 dark:bg-orange-900/30',
                'gray': 'text-gray-700 bg-gray-100 dark:text-gray-300 dark:bg-gray-800',
                'pink': 'text-pink-700 bg-pink-100 dark:text-pink-300 dark:bg-pink-900/30',
                'cyan': 'text-cyan-700 bg-cyan-100 dark:text-cyan-300 dark:bg-cyan-900/30',
                'indigo': 'text-indigo-700 bg-indigo-100 dark:text-indigo-300 dark:bg-indigo-900/30',
                'fuchsia': 'text-fuchsia-700 bg-fuchsia-100 dark:text-fuchsia-300 dark:bg-fuchsia-900/30',
                'rose': 'text-rose-700 bg-rose-100 dark:text-rose-300 dark:bg-rose-900/30',
                'lime': 'text-lime-700 bg-lime-100 dark:text-lime-300 dark:bg-lime-900/30',
                'amber': 'text-amber-700 bg-amber-100 dark:text-amber-300 dark:bg-amber-900/30',
                'sky': 'text-sky-700 bg-sky-100 dark:text-sky-300 dark:bg-sky-900/30',
                'teal': 'text-teal-700 bg-teal-100 dark:text-teal-300 dark:bg-teal-900/30',
                'emerald': 'text-emerald-700 bg-emerald-100 dark:text-emerald-300 dark:bg-emerald-900/30',
                'violet': 'text-violet-700 bg-violet-100 dark:text-violet-300 dark:bg-violet-900/30',
                'slate': 'text-slate-700 bg-slate-100 dark:text-slate-300 dark:bg-slate-900/30'
            };
            
            // Map specific colors that might fall through or match existing keys
            if(c === 'emerald' || c === 'teal') return colorMap[c];
            if(c === 'fuchsia' || c === 'violet' || c === 'indigo' || c === 'rose' || c === 'sky' || c === 'lime' || c === 'amber' || c === 'cyan' || c === 'pink' || c === 'slate') return colorMap[c];
            
            return colorMap[c] || colorMap['gray'];
        }

        function renderLibraryFilters() {
            const container = document.getElementById('library-filter-select');
            if(!container) return;
            const subjects = new Set(['Todos']);
            syllabusDB.forEach(item => subjects.add(item.cat));
            container.innerHTML = Array.from(subjects).map(sub => `<option value="${sub}" ${sub === currentLibFilter ? 'selected' : ''}>${sub}</option>`).join('');
        }

        window.setLibraryFilter = (filter) => {
            currentLibFilter = filter;
            searchContent();
        }

        window.searchContent = () => {
            const query = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('library-results');
            if (!container) return;

            let results = syllabusDB.filter(i => 
                i.title.toLowerCase().includes(query) || i.text.toLowerCase().includes(query) || i.cat.toLowerCase().includes(query)
            );

            if(currentLibFilter !== 'Todos') results = results.filter(i => i.cat === currentLibFilter);
            
            if (results.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-12 text-sm">Nada encontrado.</div>`;
                return;
            }

            container.innerHTML = results.map(item => {
                const colorClass = getSubjectColorClass(item.cat);
                return `
                <div class="bg-white dark:bg-dark-900 p-6 rounded-2xl border border-slate-100 dark:border-white/5 hover:border-blue-400 dark:hover:border-neon-blue transition-all cursor-pointer group flex flex-col h-full shadow-sm hover:shadow-md" onclick="openContentModal('${item.id}')">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded-md ${colorClass} flex items-center gap-1">${item.cat}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 dark:text-white text-base md:text-lg leading-tight group-hover:text-blue-500 dark:group-hover:text-neon-blue transition-colors mb-2">${item.title}</h3>
                    <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400 line-clamp-3 leading-relaxed flex-1">${item.text}</p>
                </div>`
            }).join('');
        }

        window.openContentModal = (id) => {
            let item = null;
            scheduleData.forEach(d => {
                const found = d.items.find(i => i.id === id);
                if(found) item = found;
            });
            if(!item) return;

            currentTopicTitle = item.subj;
            currentTopicContext = item.desc;
            document.getElementById('modal-tag').innerText = item.subj;
            document.getElementById('modal-title').innerText = item.desc;
            document.getElementById('modal-body').innerText = `T√≥pico: ${item.desc}.`;
            document.getElementById('quiz-box').classList.add('hidden');
            const btn = document.getElementById('btn-quiz');
            if (btn) { btn.innerHTML = 'Gerar Resumo IA'; btn.disabled = false; }
            document.getElementById('content-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('content-modal').classList.add('hidden');

        async function generateQuiz() {
            const btn = document.getElementById('btn-quiz');
            const box = document.getElementById('quiz-box');
            const content = document.getElementById('quiz-content');

            if (btn) { btn.disabled = true; btn.innerHTML = 'Analisando...'; }
            if (box) box.classList.remove('hidden');
            if (content) content.innerHTML = '<div class="animate-pulse h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4"></div>';

            const prompt = `Atue como Mentor. Mat√©ria: ${currentTopicTitle}. T√≥pico: ${currentTopicContext}. Resumo curto e 3 quest√µes Certo/Errado.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                if (content) content.innerHTML = marked.parse(text);
                if (btn) btn.innerHTML = 'Gerado';
            } catch(e) {
                if (content) content.innerText = "Erro IA.";
                if (btn) btn.disabled = false;
            }
        }

        async function generateDailyBriefing(dateStr) {
            const container = document.getElementById('daily-briefing-content');
            const loading = document.getElementById('daily-briefing-loading');
            if (!container || !loading) return;
            if (intelCache[dateStr]) {
                loading.classList.add('hidden');
                container.innerHTML = intelCache[dateStr];
                container.classList.remove('hidden');
                return;
            }
            container.classList.add('hidden');
            loading.classList.remove('hidden');

            const data = scheduleData.find(d => d.date === dateStr);
            if(!data || !data.items.length) {
                loading.classList.add('hidden');
                container.innerHTML = "<div class='text-center text-slate-500 py-4 text-sm'>Sem briefing hoje.</div>";
                container.classList.remove('hidden');
                return;
            }

            const subjects = data.items.map(i => `${i.subj}: ${i.desc}`).join('; ');
            const prompt = `Resumo t√°tico curto para: ${subjects}. Use emojis e negrito.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await res.json();
                const text = json.candidates[0].content.parts[0].text;
                const html = marked.parse(text);
                intelCache[dateStr] = html;
                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = "<div class='text-red-500 text-center text-xs'>Erro de conex√£o.</div>";
            } finally {
                loading.classList.add('hidden');
                container.classList.remove('hidden');
            }
        }

        window.openExternalSearch = (type) => {
            const q = `Concurso SEC BA ${currentTopicTitle} ${currentTopicContext}`;
            window.open(type === 'youtube' ? `https://www.youtube.com/results?search_query=${q}` : `https://www.google.com/search?q=${q}`, '_blank');
        }

        function updateChartTheme() {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;
            const counts = {};
            scheduleData.forEach(d => d.items.forEach(i => { if (userProgress.includes(i.id)) counts[i.subj] = (counts[i.subj] || 0) + 1; }));
            const labels = Object.keys(counts).length ? Object.keys(counts) : ['Pendente'];
            const values = Object.keys(counts).length ? Object.values(counts) : [1];
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#ffffff' : '#1e293b';
            const colors = Object.keys(counts).length ? ['#3b82f6', '#bc13fe', '#10b981', '#ef4444', '#f59e0b', '#64748b'] : [isDark ? '#374151' : '#e2e8f0'];

            const data = { labels: labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] };
            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.options.plugins.legend.labels.color = textColor;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut', data: data,
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, color: textColor, font: { size: 10, family: 'Inter' } } } }, cutout: '70%' }
                });
            }
        }

        function closeLevelUp() { document.getElementById('level-up-modal').classList.add('hidden'); }
        
        window.closeProfileModal = () => document.getElementById('profile-modal').classList.add('hidden');
        
        window.openProfileModal = () => {
            const modal = document.getElementById('profile-modal');
            if(!modal) return;
            
            const user = window.auth.currentUser;
            if(user) {
                document.getElementById('profile-name-display').innerText = user.displayName || 'Estudante';
                document.getElementById('profile-email-display').innerText = user.email || 'Convidado';
                document.getElementById('edit-profile-name').value = user.displayName || '';
                document.getElementById('edit-profile-email').value = user.email || '';
            }

            const level = parseInt(document.getElementById('level-circle').innerText) || 1;
            const container = document.getElementById('profile-next-levels');
            let html = '';
            for(let i = level + 1; i <= Math.min(level + 10, 60); i++) {
                const rIndex = Math.min(i - 1, ranksList.length - 1);
                html += `<div class="relative pl-6 pb-6 border-l border-slate-200 dark:border-white/10 last:pb-0 last:border-0">
                    <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full bg-slate-300 dark:bg-white/20"></div>
                    <div class="flex justify-between items-start">
                        <div><span class="text-xs font-bold text-blue-500 dark:text-blue-400">N√≠vel ${i}</span><h5 class="text-sm font-bold text-slate-800 dark:text-white">${ranksList[rIndex]}</h5></div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
            
            switchProfileTab('personal');
            modal.classList.remove('hidden');
        }

        window.switchProfileTab = (tab) => {
            ['personal', 'security', 'journey'].forEach(t => {
                document.getElementById(`tab-btn-${t}`).classList.remove('active');
                document.getElementById(`tab-content-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-btn-${tab}`).classList.add('active');
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
        }

        window.saveProfileName = async () => {
            const newName = document.getElementById('edit-profile-name').value.trim();
            if(!newName || !window.auth.currentUser) return;
            
            try {
                await window.updateProfile(window.auth.currentUser, { displayName: newName });
                document.getElementById('header-name').innerText = newName.split(' ')[0];
                document.getElementById('profile-name-display').innerText = newName;
                showToast("Sucesso", "Nome atualizado!");
            } catch(e) {
                console.error(e);
                showToast("Erro", "N√£o foi poss√≠vel atualizar.");
            }
        }

        window.handlePasswordResetProfile = async () => {
            if(!window.auth.currentUser || !window.auth.currentUser.email) return;
            try {
                await window.sendPasswordResetEmail(window.auth, window.auth.currentUser.email);
                showToast("E-mail Enviado", "Verifique sua caixa de entrada.");
            } catch(e) {
                showToast("Erro", "Falha ao enviar e-mail.");
            }
        }

        window.setTheme = (mode) => {
            localStorage.setItem('theme', mode);
            updateThemeDisplay(mode);
        }

        function updateThemeDisplay(mode) {
            ['light', 'dark', 'system'].forEach(m => document.getElementById(`theme-btn-${m}`).classList.remove('active'));
            document.getElementById(`theme-btn-${mode}`).classList.add('active');

            if (mode === 'system') {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } else if (mode === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (localStorage.getItem('theme') === 'system') {
                if (e.matches) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }
        });

        window.toggleTheme = () => {
            const current = localStorage.getItem('theme') || 'system';
            const next = current === 'light' ? 'dark' : (current === 'dark' ? 'system' : 'light');
            setTheme(next);
        }

        async function handleChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const btn = e.target.querySelector('button');
            const container = document.getElementById('chat-container');
            const userText = input.value.trim();
            if (!userText) return;

            container.innerHTML += `<div class="flex gap-3 justify-end animate-in fade-in slide-in-from-bottom-2 duration-300"><div class="bg-blue-600 text-white rounded-2xl rounded-tr-none p-3 text-sm shadow-sm">${userText}</div></div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;
            btn.disabled = true;

            const loadingId = 'loading-' + Date.now();
            container.innerHTML += `<div id="${loadingId}" class="flex gap-3 animate-pulse"><div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-white/10 shrink-0"></div><div class="bg-white dark:bg-dark-700 border border-slate-100 dark:border-white/5 rounded-2xl rounded-tl-none p-4 w-24 h-10"></div></div>`;
            container.scrollTop = container.scrollHeight;

            try {
                const prompt = `Mentor SEC/BA. Aluno: "${userText}". Breve e motivador.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                document.getElementById(loadingId).remove();
                container.innerHTML += `<div class="flex gap-3 animate-in fade-in slide-in-from-bottom-2 duration-300"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-neon-purple to-blue-600 flex items-center justify-center text-white text-[10px] font-bold shrink-0 shadow-sm">IA</div><div class="bg-white dark:bg-dark-700 p-3 rounded-2xl rounded-tl-none border border-slate-100 dark:border-white/5 text-sm text-slate-700 dark:text-slate-200 shadow-sm prose prose-sm dark:prose-invert max-w-none">${marked.parse(aiText)}</div></div>`;
            } catch (err) {
                document.getElementById(loadingId).remove();
                container.innerHTML += `<div class="text-red-500 text-xs mt-2">Erro.</div>`;
            }
            btn.disabled = false;
            container.scrollTop = container.scrollHeight;
        }

        function toggleFullscreenPDF() {
            const modal = document.getElementById('pdf-modal');
            const iframe = document.getElementById('pdf-frame-fullscreen');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                if (!iframe.src || iframe.src === 'about:blank') iframe.src = 'edital.pdf';
            } else {
                modal.classList.add('hidden');
            }
        }
    </script>
</body>
</html>